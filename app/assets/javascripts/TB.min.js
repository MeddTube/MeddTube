/*
  OpenTok JavaScript Library v2.0.18
 http://www.tokbox.com/

 Copyright (c) 2013 TokBox, Inc.

 Date: March 03 10:04:11 2014
  Common JS Helpers on OpenTok 0.1.0 628a0b9 master
 http://www.tokbox.com/

 Copyright (c) 2014 TokBox, Inc.

 Date: January 08 04:13:37 2014

*/
(function(k){k.OT||(k.OT={});OT.properties={version:"v2.0.18",build:"f671691",debug:"false",websiteURL:"http://www.tokbox.com",cdnURL:"http://static.opentok.com",loggingURL:"http://hlg.tokbox.com/prod",apiURL:"http://anvil.opentok.com",messagingProtocol:"wss",messagingPort:443,supportSSL:"true",cdnURLSSL:"https://swww.tokbox.com",loggingURLSSL:"https://hlg.tokbox.com/prod",
apiURLSSL:"https://anvil.opentok.com"}})(window);
!function(k,c){var e=function(a){return document.getElementById(a)},g=k.OTHelpers;k.OTHelpers=e;e.noConflict=function(){e.noConflict=function(){return e};k.OTHelpers=g;return e};e.isEmpty=function(a){if(null===a||a===c)return!0;if(Array.isArray(a)||"string"===typeof a)return 0===a.length;for(var d in a)if(a.hasOwnProperty(d))return!1;return!0};e.isNone=function(a){return a===c||null===a};e.isObject=function(a){return a===Object(a)};e.isFunction=function(a){return"function"===typeof a};e.extend=function(){var a=
Array.prototype.slice.call(arguments),d=a.shift();a.forEach(function(a){for(var b in a)d[b]=a[b]});return d};e.defaults=function(){var a=Array.prototype.slice.call(arguments),d=a.shift();a.forEach(function(a){for(var b in a)void 0===d[b]&&(d[b]=a[b])});return d};e.clone=function(a){return!e.isObject(a)?a:Array.isArray(a)?a.slice():e.extend({},a)};e.noop=function(){};e.supportsWebSockets=function(){return"WebSocket"in k};e.now=function(){var a=k.performance||{},d,b=a.now||a.mozNow||a.msNow||a.oNow||
a.webkitNow;return b?(b=b.bind(a),d=a.timing.navigationStart,function(){return d+b()}):function(){return(new Date).getTime()}}();e.browser=function(){var a=k.navigator.userAgent.toLowerCase(),d,b="Unknown";-1<a.indexOf("firefox")&&(b="Firefox");-1<a.indexOf("opera")?b="Opera":-1<a.indexOf("msie")?b="IE":-1<a.indexOf("chrome")&&(b="Chrome");if((d=k.navigator.vendor)&&-1<d.toLowerCase().indexOf("apple"))b="Safari";a=null;e.browser=function(){return b};return b};e.canDefineProperty=!0;try{Object.defineProperty({},
"x",{})}catch(a){e.canDefineProperty=!1}e.defineGetters=function(a,b,d){var f={};void 0===d&&(d=!1);for(var h in b)f[h]={get:b[h],enumerable:d};Object.defineProperties(a,f)};Object.create||(Object.create=function(a){function d(){}if(1<arguments.length)throw Error("Object.create implementation only accepts the first parameter.");d.prototype=a;return new d});e.setCookie=function(a,d){try{localStorage.setItem(a,d)}catch(b){var f=new Date;f.setTime(f.getTime()+31536E6);f="; expires\x3d"+f.toGMTString();
document.cookie=a+"\x3d"+d+f+"; path\x3d/"}};e.getCookie=function(a){var d;try{return d=localStorage.getItem("opentok_client_id")}catch(b){a+="\x3d";for(var f=document.cookie.split(";"),h=0;h<f.length;h++){for(var c=f[h];" "==c.charAt(0);)c=c.substring(1,c.length);0===c.indexOf(a)&&(d=c.substring(a.length,c.length))}if(d)return d}return null};e.invert=function(a){var d={},b;for(b in a)a.hasOwnProperty(b)&&(d[a[b]]=b);return d};var d={escape:{"\x26":"\x26amp;","\x3c":"\x26lt;","\x3e":"\x26gt;",'"':"\x26quot;",
"'":"\x26#x27;","/":"\x26#x2F;"}};d.unescape=e.invert(d.escape);var b={escape:RegExp("["+Object.keys(d.escape).join("")+"]","g"),unescape:RegExp("("+Object.keys(d.unescape).join("|")+")","g")};["escape","unescape"].forEach(function(a){e[a]=function(f){return null===f||f===c?"":(""+f).replace(b[a],function(b){return d[a][b]})}});e.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var h=/(.)^/,f={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028",
"\u2029":"u2029"},l=/\\|'|\r|\n|\t|\u2028|\u2029/g;e.template=function(a,d,b){var c;b=e.defaults({},b,e.templateSettings);var g=RegExp([(b.escape||h).source,(b.interpolate||h).source,(b.evaluate||h).source].join("|")+"|$","g"),k=0,s="__p+\x3d'";a.replace(g,function(d,b,h,c,g){s+=a.slice(k,g).replace(l,function(a){return"\\"+f[a]});b&&(s+="'+\n((__t\x3d("+b+"))\x3d\x3dnull?'':OTHelpers.escape(__t))+\n'");h&&(s+="'+\n((__t\x3d("+h+"))\x3d\x3dnull?'':__t)+\n'");c&&(s+="';\n"+c+"\n__p+\x3d'");k=g+d.length;
return d});s+="';\n";b.variable||(s="with(obj||{}){\n"+s+"}\n");s="var __t,__p\x3d'',__j\x3dArray.prototype.join,print\x3dfunction(){__p+\x3d__j.call(arguments,'');};\n"+s+"return __p;\n";try{c=new Function(b.variable||"obj",s)}catch(u){throw u.source=s,u;}if(d)return c(d);d=function(a){return c.call(this,a)};d.source="function("+(b.variable||"obj")+"){\n"+s+"}";return d}}(window);
(function(k,c,e){c.statable=function(g,a,d,b,h){var f,e=d;g.is=function(){return-1!==Array.prototype.indexOf.call(arguments,e)};g.isNot=function(){return-1===Array.prototype.indexOf.call(arguments,e)};Object.defineProperties(g,{state:{get:function(){return e}},previousState:{get:function(){return f}}});return function(d){e!==d&&(-1===a.indexOf(d)?h&&c.isFunction(h)&&h("invalidState",d):(f=e,e=d,b&&c.isFunction(b)&&b(d,f)))}}})(window,window.OTHelpers);
(function(k,c,e){function g(a,d){var b=d||0,f=n;return f[a[b++]]+f[a[b++]]+f[a[b++]]+f[a[b++]]+"-"+f[a[b++]]+f[a[b++]]+"-"+f[a[b++]]+f[a[b++]]+"-"+f[a[b++]]+f[a[b++]]+"-"+f[a[b++]]+f[a[b++]]+f[a[b++]]+f[a[b++]]+f[a[b++]]+f[a[b++]]}function a(a,b,d){d=b&&d||0;"string"==typeof a&&(b="binary"==a?new l(16):null,a=null);a=a||{};a=a.random||(a.rng||f)();a[6]=a[6]&15|64;a[8]=a[8]&63|128;if(b)for(var h=0;16>h;h++)b[d+h]=a[h];return b||g(a)}var d,b=Array(16);e=function(){for(var a,d=0,d=0;16>d;d++)0===(d&
3)&&(a=4294967296*Math.random()),b[d]=a>>>((d&3)<<3)&255;return b};if(k.crypto&&crypto.getRandomValues){var h=new Uint32Array(4);d=function(){crypto.getRandomValues(h);for(var a=0;16>a;a++)b[a]=h[a>>2]>>>8*(a&3)&255;return b}}var f=d||e,l="function"==typeof Buffer?Buffer:Array,n=[],m={};for(k=0;256>k;k++)n[k]=(k+256).toString(16).substr(1),m[n[k]]=k;a.v4=a;a.parse=function(a,b,d){var f=b&&d||0,h=0;b=b||[];for(a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){16>h&&(b[f+h++]=m[a])});16>h;)b[f+h++]=
0;return b};a.unparse=g;a.BufferClass=l;a.mathRNG=e;a.whatwgRNG=d;c.uuid=a})(window,window.OTHelpers);
(function(k,c,e){function g(a){Object.defineProperty(a.prototype,"firstElementChild",{get:function(){var a;for(a=this.firstChild;a&&1!=a.nodeType;)a=a.nextSibling;return a}});Object.defineProperty(a.prototype,"lastElementChild",{get:function(){var a;for(a=this.lastChild;a&&1!=a.nodeType;)a=a.previousSibling;return a}});Object.defineProperty(a.prototype,"nextElementSibling",{get:function(){for(var a=this;!c.isNone(a=a.nextSibling)&&1!=a.nodeType;);return a}});Object.defineProperty(a.prototype,"previousElementSibling",
{get:function(){for(var a=this;!c.isNone(a=a.previousSibling)&&1!=a.nodeType;);return a}})}c.parseXML=function(a){var d;k.DOMParser?d=(new DOMParser).parseFromString(a,"text/xml"):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(a),g(d));a=d.documentElement;return!a||!a.nodeName||"parsererror"===a.nodeName?null:d}})(window,window.OTHelpers);
(function(k,c,e){c.useLogHelpers=function(c){function a(a,b,e){return function(){if(c.shouldLog(b)){var m=k.console;if(m&&m[a])if(m[a].apply||Function.prototype.bind)m[a].apply||(m[a]=Function.prototype.bind.call(m[a],m)),m[a].apply(m,arguments);else m[a](Array.prototype.slice.apply(arguments).join(" "));else e&&e.apply(c,arguments);if(m=arguments){var r;try{r=JSON.stringify(m)}catch(q){r=m.toString()}2>=r.length||h.push([a,d(),r])}}}}function d(){var a=new Date;return a.toLocaleTimeString()+a.getMilliseconds()}
c.DEBUG=5;c.LOG=4;c.INFO=3;c.WARN=2;c.ERROR=1;c.NONE=0;var b=c.NONE,h=[];c.log=a("log",c.LOG);c.debug=a("debug",c.DEBUG,c.log);c.info=a("info",c.INFO,c.log);c.warn=a("warn",c.WARN,c.log);c.error=a("error",c.ERROR,c.log);c.setLogLevel=function(a){b="number"===typeof a?a:0;c.debug("TB.setLogLevel("+b+")");return b};c.getLogs=function(){return h};c.shouldLog=function(a){return b>=a}};c.useLogHelpers(c);c.setLogLevel(c.ERROR)})(window,window.OTHelpers);
(function(k,c,e){c.castToBoolean=function(c,a){return c===e?a:"true"===c||!0===c};c.roundFloat=function(c,a){return Number(c.toFixed(a))}})(window,window.OTHelpers);
(function(k,c,e){var g=[],a="OTHelpers."+c.uuid.v4()+".zero-timeout";k.addEventListener("message",function(d){d.source==k&&d.data==a&&(d.stopPropagation(),0<g.length&&(d=g.shift(),d.shift().apply(null,d)))},!0);c.callAsync=function(){g.push(Array.prototype.slice.call(arguments));k.postMessage(a,"*")};c.createAsyncHandler=function(a){return function(){var b=Array.prototype.slice.call(arguments);c.callAsync(function(){a.apply(null,b)})}}})(window,window.OTHelpers);
(function(k,c,e){c.eventing=function(e,a){function d(a,b,d){var f=h[a];if(f&&0!==f.length){var e=f.length;f.forEach(function(f){function g(a){return a.context===f.context&&a.handler===f.handler}c.callAsync(function(){try{h[a]&&h[a].some(g)&&(f.closure||f.handler).apply(f.context||null,b)}finally{e--,0===e&&d&&d.apply(null,b.slice())}})})}}function b(a,b){var d=h[a];d&&0!==d.length&&d.forEach(function(a){(a.closure||a.handler).apply(a.context||null,b)})}var h={},f=!0===a?b:d,l=function(a,b){h[a]&&
(b?h[a]=h[a].filter(function(a){return a.context!==b}):delete h[a])},n=function(a,b,d,f){var c={handler:b};d&&(c.context=d);f&&(c.closure=f);a.forEach(function(a){h[a]||(h[a]=[]);h[a].push(c)})}.bind(e),m=function(a,b,d){function f(a){return!(a.handler===b&&a.context===d)}a.forEach(function(a){h[a]&&(h[a]=h[a].filter(f),0===h[a].length&&delete h[a])})}.bind(e);e.dispatchEvent=function(a,b){if(!a.type)throw c.error("OTHelpers.Eventing.dispatchEvent: Event has no type"),c.error(a),Error("OTHelpers.Eventing.dispatchEvent: Event has no type");
a.target||(a.target=this);if(!h[a.type]||0===h[a.type].length){var d=[a];b&&b.apply(null,d.slice())}else return f(a.type,[a],b),this};e.trigger=function(a){if(h[a]&&0!==h[a].length){var b=Array.prototype.slice.call(arguments);b.shift();f(a,b);return this}};e.on=function(a,b,d){if("string"===typeof a&&b)n(a.split(" "),b,d);else for(var f in a)a.hasOwnProperty(f)&&n([f],a[f],b);return this};e.off=function(a,b,d){if("string"===typeof a)b&&c.isFunction(b)?m(a.split(" "),b,d):a.split(" ").forEach(function(a){l(a,
b)},this);else if(a)for(var f in a)a.hasOwnProperty(f)&&m([f],a[f],b);else h={};return this};e.once=function(a,b,d){var f=a.split(" ");a=function(){var a=b.apply(d||null,arguments);m(f,b,d);return a}.bind(this);n(f,b,d,a);return this};e.addEventListener=function(a,b,d){n([a],b,d)};e.removeEventListener=function(a,b,d){m([a],b,d)};return e};c.eventing.Event=function(){return function(g,a){this.type=g;this.cancelable=a!==e?a:!0;var d=!1,b=null;this.preventDefault=function(){this.cancelable?d=!0:c.warn("Event.preventDefault :: Trying to preventDefault on an Event that isn't cancelable")};
this.isDefaultPrevented=function(){return d};c.canDefineProperty&&Object.defineProperty(this,"target",{set:function(a){b=a},get:function(){return b}})}}})(window,window.OTHelpers);
(function(k,c,e){function g(a){for(var d in a)if(a.hasOwnProperty(d))return!0;return!1}c.supportsClassList=function(){var a=typeof("undefined"!==document)&&"classList"in document.createElement("a");c.supportsClassList=function(){return a};return a};c.removeElement=function(a){a&&a.parentNode&&a.parentNode.removeChild(a)};c.removeElementById=function(a){this.removeElement(c(a))};c.removeElementsByType=function(a,d){if(a)for(var b=a.getElementsByTagName(d);b.length;)a.removeChild(b[0])};c.emptyElement=
function(a){for(;a.firstChild;)a.removeChild(a.firstChild);return a};c.createElement=function(a,d,b){a=document.createElement(a);if(d)for(var c in d)if("object"===typeof d[c]){a[c]||(a[c]={});var f=d[c],e;for(e in f)a[c][e]=f[e]}else"className"===c?a.className=d[c]:a.setAttribute(c,d[c]);b&&(a.innerHTML=b);return a};c.createButton=function(a,d,b){a=c.createElement("button",d,a);if(b){for(var h in b)if(b.hasOwnProperty(h))c.on(a,h,b[h]);a._boundEvents=b}return a};c.on=function(a,d,b){if(a.addEventListener)a.addEventListener(d,
b,!1);else if(a.attachEvent)a.attachEvent("on"+d,b);else{var c=a["on"+d];a["on"+d]=function(){b.apply(this,arguments);c&&c.apply(this,arguments)}}};c.off=function(a,d,b){a.removeEventListener?a.removeEventListener(d,b,!1):a.detachEvent&&a.detachEvent("on"+d,b)};c.isDisplayNone=function(a){return(0===a.offsetWidth||0===a.offsetHeight)&&"none"===c.css(a,"display")?!0:a.parentNode&&a.parentNode.style?c.isDisplayNone(a.parentNode):!1};c.findElementWithDisplayNone=function(a){return(0===a.offsetWidth||
0===a.offsetHeight)&&"none"===c.css(a,"display")?a:a.parentNode&&a.parentNode.style?c.findElementWithDisplayNone(a.parentNode):null};c.observeStyleChanges=function(a,d,b){var h={},f=function(b){switch(b){case "width":return c.width(a);case "height":return c.height(a);default:return c.css(a)}};d.forEach(function(a){h[a]=f(a)});var e=new MutationObserver(function(e){var l={};e.forEach(function(b){if("style"===b.attributeName){var e=c.isDisplayNone(a);d.forEach(function(a){if(!e||!("width"==a||"height"==
a)){var b=f(a);b!==h[a]&&(l[a]=[h[a],b],h[a]=b)}})}});g(l)&&c.callAsync(function(){b.call(null,l)})});e.observe(a,{attributes:!0,attributeFilter:["style"],childList:!1,characterData:!1,subtree:!1});return e};c.observeNodeOrChildNodeRemoval=function(a,d){var b=new MutationObserver(function(a){var b=[];a.forEach(function(a){a.removedNodes.length&&(b=b.concat(Array.prototype.slice.call(a.removedNodes)))});b.length&&c.callAsync(function(){d(b)})});b.observe(a,{attributes:!1,childList:!0,characterData:!1,
subtree:!0});return b}})(window,window.OTHelpers);
(function(k,c,e){c.Modal=function(e,a){this.el=c.createElement("section",{className:"OT_root OT_dialog OT_modal"},c.template("        \x3cheader\x3e            \x3ch1\x3e\x3c%%\x3d title %\x3e\x3c/h1\x3e        \x3c/header\x3e        \x3cdiv class\x3d'OT_dialog-body'\x3e            \x3c%%\x3d body %\x3e        \x3c/div\x3e    ",{title:e,body:a}));this.el.style.display="none";document.body.appendChild(this.el);c.centerElement(this.el);c.show(this.el);this.close=function(){c.removeElement(this.el);
this.el=null;return this}};c.tbAlert=function(e,a){var d=new c.Modal(e,"\x3cdiv\x3e"+a+"\x3c/div\x3e");c.addClass(d.el,"OT_tbalert");var b=c.createElement("input",{className:"OT_closeButton",type:"button",value:"close"});d.el.appendChild(b);b.onclick=function(){d&&d.close();d=null}}})(window,window.OTHelpers);
(function(k,c,e){c.addClass=function(a,d){if(1===a.nodeType){var b=d.trim().split(/\s+/),h,f;if(c.supportsClassList()){h=0;for(f=b.length;h<f;++h)a.classList.add(b[h])}else{if(!a.className&&1===b.length)a.className=d;else{var e=" "+a.className+" ";h=0;for(f=b.length;h<f;++h)~e.indexOf(" "+b[h]+" ")||(e+=b[h]+" ");a.className=e.trim()}return this}}};c.removeClass=function(a,d){if(d&&1===a.nodeType){var b=d.trim().split(/\s+/),h,f;if(c.supportsClassList()){h=0;for(f=b.length;h<f;++h)a.classList.remove(b[h])}else{var e=
(" "+a.className+" ").replace(/[\s+]/," ");h=0;for(f=b.length;h<f;++h)e=e.replace(" "+b[h]+" "," ");a.className=e.trim();return this}}};var g=function(a){return 0<a.offsetHeight?a.offsetHeight+"px":c.css(a,"height")};c.width=function(a,d){return d?(c.css(a,"width",d),this):c.isDisplayNone(a)?c.makeVisibleAndYield(a,function(){return 0<a.offsetWidth?a.offsetWidth+"px":c.css(a,"width")}):0<a.offsetWidth?a.offsetWidth+"px":c.css(a,"width")};c.height=function(a,d){return d?(c.css(a,"height",d),this):
c.isDisplayNone(a)?c.makeVisibleAndYield(a,function(){return g(a)}):g(a)};c.centerElement=function(a,d,b){d||(d=parseInt(c.width(a),10));b||(b=parseInt(c.height(a),10));c.css(a,"margin",-0.5*b+"px 0 0 "+(-0.5*d+"px"));c.addClass(a,"OT_centered")}})(window,window.OTHelpers);
(function(k,c,e){var g={},a={};c.show=function(d){var b=d.style.display;if(""===b||"none"===b)d.style.display=g[d]||"",delete g[d];if("none"===d.ownerDocument.defaultView.getComputedStyle(d,null).getPropertyValue("display")){g[d]="none";b=d.style;if(a[d.ownerDocument]&&a[d.ownerDocument][d.nodeName])d=a[d.ownerDocument][d.nodeName];else{a[d.ownerDocument]||(a[d.ownerDocument]={});var h=d.ownerDocument.createElement(d.nodeName);d.ownerDocument.body.appendChild(h);d=a[d.ownerDocument][d.nodeName]=c.css(h,
"display");c.removeElement(h)}b.display=d}return this};c.hide=function(a){if("none"!==a.style.display)return g[a]=a.style.display,a.style.display="none",this};c.css=function(a,b,c){if("string"!==typeof b){a=a.style;for(var f in b)a[f]=b[f];return this}if(c!==e)return a.style[b]=c,this;b=b.replace(/([A-Z]|^ms)/g,"-$1").toLowerCase();f=a.ownerDocument.defaultView.getComputedStyle(a,null).getPropertyValue(b);""===f&&(f=a.style[b]);return f};c.applyCSS=function(a,b,h){var f={},e;for(e in b)b.hasOwnProperty(e)&&
(f[e]=a.style[e],c.css(a,e,b[e]));h=h();for(e in b)b.hasOwnProperty(e)&&c.css(a,e,f[e]||"");return h};c.makeVisibleAndYield=function(a,b){var h=c.findElementWithDisplayNone(a);if(h)return c.applyCSS(h,{display:"block",visibility:"hidden"},b)}})(window,window.OTHelpers);
(function(k,c,e){function g(a){if("string"===typeof a)return a;var b=[],c;for(c in a)b.push(encodeURIComponent(c)+"\x3d"+encodeURIComponent(a[c]));return b.join("\x26").replace(/\+/g,"%20")}c.getXML=function(a,b){var h=b&&b.success,f=c.extend(b.headers||{},{"Content-Type":"application/xml"});c.get(a,c.extend(b||{},{success:function(a){var d=a.target.responseXML,f;d?(f=d.documentElement,f=!f||!f.nodeName||"parsererror"===f.nodeName?!1:!0):f=!1;f?h&&h(d,a,a.target):b&&b.error&&b.error(a,a.target)},
headers:f}))};c.getJSON=function(a,b){var h=b&&b.success;c.get(a,c.extend(b||{},{success:function(a){var d;try{d=JSON.parse(a.target.responseText)}catch(c){b&&b.error&&b.error(a,a.target);return}h&&h(d,a,a.target)},headers:{"Content-Type":"application/json"}}))};c.get=function(d,b){var c=new XMLHttpRequest,f=b||{};a(c,f.success,f.error);f.process&&c.addEventListener("progress",f.progress,!1);f.cancelled&&c.addEventListener("abort",f.cancelled,!1);c.open("GET",d,!0);f.headers||(f.headers={});for(var e in f.headers)c.setRequestHeader(e,
f.headers[e]);c.send()};c.post=function(d,b){var c=new XMLHttpRequest,f=b||{};a(c,f.success,f.error);f.process&&c.addEventListener("progress",f.progress,!1);f.cancelled&&c.addEventListener("abort",f.cancelled,!1);c.open("POST",d,!0);f.headers||(f.headers={});for(var e in f.headers)c.setRequestHeader(e,f.headers[e]);c.send(g(f.data))};c.postFormData=function(a,b,e){if(!b)throw Error("OTHelpers.postFormData must be passed a data options.");var f=new FormData,g;for(g in b)f.append(g,b[g]);c.post(a,c.extend(e||
{},{data:f}))};c.getJSONP=function(a,b){var h,f=document.head||document.getElementsByTagName("head")[0],g,n=a,m=c.extend(b||{},{callbackParameter:"callback"}),k=function(){g&&(clearTimeout(g),g=null);h&&(h.onload=h.onreadystatechange=null,c.removeElement(h),h=e)},q=function(){if((!h.readyState||/loaded|complete/.test(h.readyState))&&g)clearTimeout(g),g=null};m.callbackName="jsonp_callback_"+ +new Date;this.jsonp_callbacks[m.callbackName]=function(a){k();m.success&&m.success(a)};n+=(/\?/.test(n)?"\x26":
"?")+m.callbackParameter+"\x3d"+m.callbackName;h=c.createElement("script",{async:"async",src:n,onload:q,onreadystatechange:q});f.appendChild(h);g=setTimeout(function(){k();c.error("The JSONP request to "+n+" timed out after 30000ms.");m.error&&m.error("The JSONP request to "+a+" timed out after 30000ms.",n,m)},3E4)};var a=function(a,b,c){a.addEventListener("load",function(a){var d=a.target.status;200<=d&&300>d||304===d?b&&b.apply(null,arguments):c&&c(a)},!1);c&&a.addEventListener("error",c,!1)}})(window,
window.OTHelpers);
!function(k){k.OT||(k.OT={});OT.$=OTHelpers.noConflict();OT.$.eventing(OT);OT.Modal=OT.$.Modal;OT.$.useLogHelpers(OT);var c=!1,e=OT.setLogLevel;OT.setLogLevel=function(g){OT.$.setLogLevel(g);g=e.call(OT,g);OT.shouldLog(OT.DEBUG)&&!c&&(OT.debug("OpenTok JavaScript library "+OT.properties.version),OT.debug("Release notes: "+OT.properties.websiteURL+"/opentok/webrtc/docs/js/release-notes.html"),OT.debug("Known issues: "+OT.properties.websiteURL+"/opentok/webrtc/docs/js/release-notes.html#knownIssues"),c=
!0);OT.debug("TB.setLogLevel("+g+")");return g};OT.setLogLevel(OT.properties.debug?OT.DEBUG:OT.ERROR)}(window);
(function(k){k.OT||(k.OT={});if(!OT.properties)throw Error("OT.properties does not exist, please ensure that you include a valid properties file.");var c=OT,e=OT.properties,g=OT.$.clone(e);g.debug="true"===e.debug||!0===e.debug;g.supportSSL="true"===e.supportSSL||!0===e.supportSSL;g.supportSSL&&(0<=k.location.protocol.indexOf("https")||0<=k.location.protocol.indexOf("chrome-extension"))?(g.assetURL=g.cdnURLSSL+"/webrtc/"+g.version,g.loggingURL=g.loggingURLSSL,g.apiURL=g.apiURLSSL):g.assetURL=g.cdnURL+
"/webrtc/"+g.version;g.configURL=g.assetURL+"/js/dynamic_config.min.js";g.cssURL=g.assetURL+"/css/ot.min.css";c.properties=g})(window);
(function(k){OT.Config=function(){var c=!1,e={},g={},a,d=document.head||document.getElementsByTagName("head")[0],b,h=function(){b&&(clearTimeout(b),b=null);a&&(a.onload=a.onreadystatechange=null,d&&a.parentNode&&d.removeChild(a),a=void 0)},f=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))b&&(clearTimeout(b),b=null),c||l._onLoadTimeout()},l={loadTimeout:4E3,load:function(e){if(!e)throw Error("You must pass a valid configUrl to Config.load");c=!1;setTimeout(function(){a=document.createElement("script");
a.async="async";a.src=e;a.onload=a.onreadystatechange=f.bind(this);d.appendChild(a)},1);b=setTimeout(function(){l._onLoadTimeout()},this.loadTimeout)},_onLoadTimeout:function(){h();OT.warn("TB DynamicConfig failed to load in "+l.loadTimeout+" ms");this.trigger("dynamicConfigLoadFailed")},isLoaded:function(){return c},reset:function(){h();c=!1;e={};g={}},replaceWith:function(a){h();a||(a={});e=a.global||{};g=a.partners||{};c||(c=!0);this.trigger("dynamicConfigChanged")},get:function(a,b,d){a=d&&g[d]&&
g[d][a]?g[d][a]:e[a];return a?a[b]:null}};OT.$.eventing(l);return l}()})(window);
(function(k){function c(a,d,b,c,f){d=d?parseInt(d,10):parseInt(OT.$.width(a.parentNode),10);b=b?parseInt(b,10):parseInt(OT.$.height(a.parentNode),10);if(!(0===d||0===b))if(c||(c=e),b=(d+0)/b,d={width:"100%",height:"100%",left:0,top:0},b>c?(c=100*(b/c),d.height=c+"%",d.top="-"+(c-100)/2+"%"):b<c&&(c=100*(c/b),d.width=c+"%",d.left="-"+(c-100)/2+"%"),OT.$.css(a,d),c=a.querySelector("video"))f?(f=a.offsetWidth,a=a.offsetHeight,d={width:a+"px",height:f+"px",marginTop:"",marginLeft:""},a=f-a,d.marginLeft=
a/2+"px",d.marginTop=-(a/2)+"px",OT.$.css(c,d)):OT.$.css(c,{width:"",height:"",marginTop:"",marginLeft:""})}var e=4/3,g=function(a,d){var b,c;a&&a.nodeName?(b=a,(!b.getAttribute("id")||0===b.getAttribute("id").length)&&b.setAttribute("id","OT_"+OT.$.uuid()),c=b.getAttribute("id")):(b=OT.$(a),c=a||"OT_"+OT.$.uuid());b?OT.$.emptyElement(b):(b=OT.$.createElement("div",{id:c}),b.style.backgroundColor="#000000",document.body.appendChild(b));null==d||"replace"==d||(c=document.createElement("div"),c.id=
"OT_"+OT.$.uuid(),"append"==d?(b.appendChild(c),b=c):"before"==d?(b.parentNode.insertBefore(c,b),b=c):"after"==d&&(b.parentNode.insertBefore(c,b.nextSibling),b=c));return b};OT.WidgetView=function(a,d){var b=g(a,d&&d.insertMode),e=document.createElement("div"),f,l,n,m,k,q=!0;d&&(width=d.width,height=d.height,width&&"number"==typeof width&&(width+="px"),height&&"number"==typeof height&&(height+="px"),b.style.width=width?width:"264px",b.style.height=height?height:"198px",b.style.overflow="hidden",(void 0===
d.mirror||d.mirror)&&OT.$.addClass(b,"OT_mirrored"));d.classNames&&OT.$.addClass(b,d.classNames);OT.$.addClass(b,"OT_loading");OT.$.addClass(e,"OT_video-container");e.style.width=b.style.width;e.style.height=b.style.height;b.appendChild(e);c(e,b.offsetWidth,b.offsetHeight);k=document.createElement("div");OT.$.addClass(k,"OT_video-loading");e.appendChild(k);m=document.createElement("div");OT.$.addClass(m,"OT_video-poster");e.appendChild(m);f=OT.$.observeStyleChanges(b,["width","height"],function(a){c(e,
a.width?a.width[1]:b.offsetWidth,a.height?a.height[1]:b.offsetHeight,l?l.aspectRatio:null)});n=OT.$.observeNodeOrChildNodeRemoval(b,function(a){l&&(a.some(function(a){return a===e||"VIDEO"===a.nodeName})&&(l.destroy(),l=null),e&&(OT.$.removeElement(e),e=null),f&&(f.disconnect(),f=null),n&&(n.disconnect(),n=null))});this.destroy=function(){f&&(f.disconnect(),f=null);n&&(n.disconnect(),n=null);l&&(l.destroy(),l=null);b&&(OT.$.removeElement(b),b=null)};Object.defineProperties(this,{showPoster:{get:function(){return!OT.$.isDisplayNone(m)},
set:function(a){a?OT.$.show(m):OT.$.hide(m)}},poster:{get:function(){return OT.$.css(m,"backgroundImage")},set:function(a){OT.$.css(m,"backgroundImage","url("+a+")")}},loading:{get:function(){return q},set:function(a){(q=a)?OT.$.addClass(b,"OT_loading"):OT.$.removeClass(b,"OT_loading")}},video:{get:function(){return l},set:function(a){l&&l.destroy();a.appendTo(e);l=a;l.on({orientationChanged:function(){c(e,b.offsetWidth,b.offsetHeight,l.aspectRatio,l.isRotated)}});c(e,b.offsetWidth,b.offsetHeight,
l?l.aspectRatio:null,l?l.isRotated:null)}},domElement:{get:function(){return b}},domId:{get:function(){return b.getAttribute("id")}}});this.addError=function(a){b.innerHTML="\x3cp\x3e"+a+"\x3cp\x3e";OT.$.addClass(b,"OT_subscriber_error")}}})(window);
(function(k){var c=function(){if(navigator.getUserMedia)return navigator.getUserMedia.bind(navigator);if(navigator.mozGetUserMedia)return navigator.mozGetUserMedia.bind(navigator);if(navigator.webkitGetUserMedia)return navigator.webkitGetUserMedia.bind(navigator)}();navigator.webkitGetUserMedia?(webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks}),webkitMediaStream.prototype.getAudioTracks||(webkitMediaStream.prototype.getAudioTracks=
function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams}),webkitRTCPeerConnection.prototype.getRemoteStreams||(webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):navigator.mozGetUserMedia&&(MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=
function(){return[]}));var e={PERMISSION_DENIED:"PERMISSION_DENIED",NOT_SUPPORTED_ERROR:"A constraint specified is not supported by the browser.",MANDATORY_UNSATISFIED_ERROR:"CONSTRAINT_NOT_SATISFIED"},g={1:"PERMISSION_DENIED"},a={PERMISSION_DENIED:"User denied permission for scripts from this origin to access the media device.",CONSTRAINT_NOT_SATISFIED:"One of the mandatory constraints could not be satisfied."},d=function(b,d){var c=d[b],e=a[c];e||(e=eventName,c=b);return{name:c,message:e}},b=function(a){if(!a||
!OT.$.isObject(a))return!0;for(var b in a)if(a[b])return!1;return!0};OT.$.supportsWebRTC=function(){var a=!1;if(navigator.webkitGetUserMedia)a="function"===typeof webkitRTCPeerConnection&&!!webkitRTCPeerConnection.prototype.addStream;else if(navigator.mozGetUserMedia){var b=k.navigator.userAgent.toLowerCase().match(/Firefox\/([0-9\.]+)/i);if(a="function"===typeof mozRTCPeerConnection&&null!==b&&20<parseFloat(b[1],10))try{new mozRTCPeerConnection,a=!0}catch(c){a=!1}}OT.$.supportsWebRTC=function(){return a};
return a};OT.$.supportedCryptoScheme=function(){if(!OT.$.supportsWebRTC())return"NONE";var a=k.navigator.userAgent.toLowerCase().match(/chrome\/([0-9\.]+)/i);return a&&25>parseFloat(a[1],10)?"SDES_SRTP":"DTLS_SRTP"};OT.$.supportsBundle=function(){return OT.$.supportsWebRTC()&&"Chrome"===OT.$.browser()};OT.$.supportsRtcpMux=function(){return OT.$.supportsWebRTC()&&"Chrome"===OT.$.browser()};OT.$.getUserMedia=function(a,f,l,n,m,k){if(b(a))OT.error("Couldn't get UserMedia: All constraints were false"),
l.call(null,{name:"NO_VALID_CONSTRAINTS",message:"Video and Audio was disabled, you need to enabled at least one"});else{var q=null,t=!1,p=function(){q=null;t=!0;n&&n()},s=function(a){q&&clearTimeout(q);t&&m&&m();f.call(null,a)},u=function(a){q&&clearTimeout(q);t&&m&&m();var b;OT.$.isObject(a)&&a.name?b={name:a.name,message:a.message,constraintName:a.constraintName}:OT.$.isObject(a)?(b=d(a.code,g),a.message&&(b.message=a.message),a.constraintName&&(b.constraintName=a.constraintName)):b=a&&e.hasOwnProperty(a)?
d(a,e):{message:"Unknown Error while getting user media"};a=b;"PERMISSION_DENIED"===a.name||"PermissionDeniedError"===a.name?k.call(null,a):l.call(null,a)};try{c(a,s,u)}catch(w){OT.error("Couldn't get UserMedia: "+w.toString());u();return}q=-1===location.protocol.indexOf("https")?setTimeout(p,100):setTimeout(p,500)}};OT.$.createPeerConnection=function(a,b){return new (k.webkitRTCPeerConnection||k.mozRTCPeerConnection)(a,b)}})(window);
(function(k){function c(a,c){var d=document.createElement("video");d.setAttribute("autoplay","");d.innerHTML=a;if(c){!0===c.muted&&(delete c.muted,d.muted="true");for(var e in c)d.setAttribute(e,c[e])}return d}function e(a){return d[parseInt(a,10)]||"An unknown error occurred."}function g(a,c,d,g){if(navigator.mozGetUserMedia||0<c.getVideoTracks().length&&c.getVideoTracks()[0].enabled){var n=function(){clearTimeout(q);a.removeEventListener("loadedmetadata",m,!1);a.removeEventListener("error",r,!1)},
m=function(a){n();d()},r=function(a){n();g("There was an unexpected problem with the Video Stream: "+e(a.target.error.code))},q=setTimeout(function(){0===a.currentTime?g("The video stream failed to connect. Please notify the site owner if this continues to happen."):(OT.warn("Never got the loadedmetadata event but currentTime \x3e 0"),d())}.bind(this),3E4);a.addEventListener("loadedmetadata",m,!1);a.addEventListener("error",r,!1);c.onended=function(){n();g("Stream ended while trying to bind it to a video element.")}}else d();
void 0!==a.srcObject?a.srcObject=c:void 0!==a.mozSrcObject?a.mozSrcObject=c:a.src=k.URL.createObjectURL(c);a.play()}OT.VideoOrientation={ROTATED_NORMAL:"OTVideoOrientationRotatedNormal",ROTATED_LEFT:"OTVideoOrientationRotatedLeft",ROTATED_RIGHT:"OTVideoOrientationRotatedRight",ROTATED_UPSIDE_DOWN:"OTVideoOrientationRotatedUpsideDown"};OT.VideoElement=function(a){var d,f,l,n=!1,m=!1;a=OT.$.defaults(a||{},{fallbackText:"Sorry, Web RTC is not available in your browser"});OT.$.eventing(this);var r=function(a){a=
"There was an unexpected problem with the Video Stream: "+e(a.target.error.code);this.trigger("error",null,a,this)}.bind(this),q=function(){n=!0;f.addEventListener("error",r,!1);this.trigger("streamBound",this)}.bind(this),t=function(a){this.trigger("loadError",OT.ExceptionCodes.P2P_CONNECTION_FAILED,a,this)}.bind(this),p=function(){m||(OT.warn("Video element paused, auto-resuming. If you intended to do this, use publishVideo(false) or subscribeToVideo(false) instead."),m=!0);f.play()};f=c(a.fallbackText,
a.attributes);f.addEventListener("pause",p);Object.defineProperties(this,{stream:{get:function(){return d}},domElement:{get:function(){return f}},parentElement:{get:function(){return l}},isBoundToStream:{get:function(){return n}},poster:{get:function(){return f.getAttribute("poster")},set:function(a){f.setAttribute("poster",a)}}});this.appendTo=function(a){l=a;l.appendChild(f);return this};this.bindToStream=function(a){n=!1;d=a;g(f,d,q,t);return this};this.unbindStream=function(){if(!d)return this;
f&&(navigator.mozGetUserMedia?f.mozSrcObject=null:k.URL.revokeObjectURL(f.src));d=null;return this};this.setAudioVolume=function(a){f&&(f.volume=OT.$.roundFloat(a/100,2))};this.getAudioVolume=function(){return f?parseInt(100*f.volume,10):50};this.whenTimeIncrements=function(a,b){if(f){var d,c=function(){!d||d>=f.currentTime?d=f.currentTime:(f.removeEventListener("timeupdate",c,!1),a.call(b,this))}.bind(this);f.addEventListener("timeupdate",c,!1)}};this.destroy=function(){this.off();this.unbindStream();
f&&(f.removeEventListener("pause",p),OT.$.removeElement(f),f=null);l=null}};OT.$.canDefineProperty&&Object.defineProperties(OT.VideoElement.prototype,{imgData:{get:function(){var a=OT.$.createElement("canvas",{width:this.domElement.videoWidth,height:this.domElement.videoHeight,style:{display:"none"}});document.body.appendChild(a);try{a.getContext("2d").drawImage(this.domElement,0,0,a.width,a.height)}catch(d){return OT.warn("Cannot get image data yet"),null}var c=a.toDataURL("image/png");OT.$.removeElement(a);
return c.replace("data:image/png;base64,","").trim()}},videoWidth:{get:function(){return this._orientation&&this._orientation.width?this._orientation.width:this.domElement["video"+(this.isRotated?"Height":"Width")]}},videoHeight:{get:function(){return this._orientation&&this._orientation.height?this._orientation.height:this.domElement["video"+(this.isRotated?"Width":"Height")]}},aspectRatio:{get:function(){return(this.videoWidth+0)/this.videoHeight}},isRotated:{get:function(){return this._orientation&&
("OTVideoOrientationRotatedLeft"==this._orientation.videoOrientation||"OTVideoOrientationRotatedRight"==this._orientation.videoOrientation)}}});var a={OTVideoOrientationRotatedNormal:"rotate(0deg)",OTVideoOrientationRotatedLeft:"rotate(90deg)",OTVideoOrientationRotatedRight:"rotate(-90deg)",OTVideoOrientationRotatedUpsideDown:"rotate(180deg)"};OT.$.canDefineProperty&&Object.defineProperty(OT.VideoElement.prototype,"orientation",{get:function(){return this._orientation},set:function(b){this._orientation=
b;b=a[b.videoOrientation]||a.ROTATED_NORMAL;switch(OT.$.browser()){case "Chrome":case "Safari":this.domElement.style.webkitTransform=b;break;case "IE":this.domElement.style.msTransform=b;break;default:this.domElement.style.transform=b}this.trigger("orientationChanged")}});var d={};k.MediaError&&(d[k.MediaError.MEDIA_ERR_ABORTED]="The fetching process for the media resource was aborted by the user agent at the user's request.",d[k.MediaError.MEDIA_ERR_NETWORK]="A network error of some description caused the user agent to stop fetching the media resource, after the resource was established to be usable.",
d[k.MediaError.MEDIA_ERR_DECODE]="An error of some description occurred while decoding the media resource, after the resource was established to be usable.",d[k.MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED]="The media resource indicated by the src attribute was not suitable. ")})(window);
(function(k){var c=[],e=!1;OT.Analytics=function(){var g=OT.properties.loggingURL+"/logging/ClientEvent",a=OT.properties.loggingURL+"/logging/ClientQos",d={},b={payloadType:"payload_type",partnerId:"partner_id",streamId:"stream_id",sessionId:"session_id",connectionId:"connection_id",widgetType:"widget_type",widgetId:"widget_id",avgAudioBitrate:"avg_audio_bitrate",avgVideoBitrate:"avg_video_bitrate",localCandidateType:"local_candidate_type",remoteCandidateType:"remote_candidate_type",transportType:"transport_type"},
h=function(b,d,c,f){OT.$.post(d?a:g,{success:c,error:f,data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"}})},f=function(){if(!e&&0<c.length){e=!0;var a=c[0],b=function(){c.shift();e=!1;f()};a&&h(a.data,a.isQos,function(){a.onComplete();setTimeout(b,50)},function(){OT.debug("Failed to send ClientEvent, moving on to the next item.");setTimeout(b,50)})}};this.logError=function(a,b,c,f,e){e||(e={});c=e.partnerId;if(!0===OT.Config.get("exceptionLogging","enabled",c)){var g;c?(g=[c,b,a].join("_"),
g=100>=(d[g]||0)):g=!1;if(!g){c=[c,b,a].join("_");var h=this.escapePayload(OT.$.extend(f||{},{message:h,userAgent:navigator.userAgent}));d[c]="undefined"!==typeof d[c]?d[c]+1:1;return this.logEvent(OT.$.extend(e,{action:b+"."+a,payloadType:h[0],payload:h[1]}))}}};this.logEvent=function(a){var d=a.partnerId;a||(a={});a=OT.$.extend({variation:"",guid:this.getClientGuid(),widget_id:"",session_id:"",connection_id:"",stream_id:"",partner_id:d,source:k.location.href,section:"",build:""},a);for(var e in b)b.hasOwnProperty(e)&&
a[e]&&(a[b[e]]=a[e],delete a[e]);c.push({data:a,onComplete:function(){},isQos:!1});f()};this.logQOS=function(a){var d=a.partnerId;a||(a={});a=OT.$.extend({guid:this.getClientGuid(),widget_id:"",session_id:"",connection_id:"",stream_id:"",partner_id:d,source:k.location.href,build:"",duration:0},a);for(var e in b)b.hasOwnProperty(e)&&a[e]&&(a[b[e]]=a[e],delete a[e]);c.push({data:a,onComplete:function(){},isQos:!0});f()};this.escapePayload=function(a){var b=[],c=[],d;for(d in a)a.hasOwnProperty(d)&&
(null!==a[d]&&void 0!==a[d])&&(b.push(a[d]?a[d].toString().replace("|","\\|"):""),c.push(d.toString().replace("|","\\|")));return[c.join("|"),b.join("|")]};this.getClientGuid=function(){var a=OT.$.getCookie("opentok_client_id");a||(a=OT.$.uuid(),OT.$.setCookie("opentok_client_id",a));return a}}})(window);
(function(k){"file:"===location.protocol&&alert("You cannot test a page using WebRTC through the file system due to browser permissions. You must run it over a web server.");k.OT||(k.OT={});!k.URL&&k.webkitURL&&(k.URL=k.webkitURL);var c,e=document.location.hash;OT.initSession=function(c){var a=OT.sessions.get(c);a||(a=new OT.Session(c),OT.sessions.add(a));return a};OT.initPublisher=function(c,a,d,b){OT.debug("TB.initPublisher("+a+")");var e=new OT.Publisher;OT.publishers.add(e);b&&OT.$.isFunction(b)&&
(c=function l(a){e.off("initSuccess",l);e.off("publishComplete",l);b.apply(null,arguments)},e.once("initSuccess",c),e.once("publishComplete",c));e.publish(a,d);return e};OT.checkSystemRequirements=function(){OT.debug("TB.checkSystemRequirements()");var c=OT.$.supportsWebSockets()&&OT.$.supportsWebRTC()?this.HAS_REQUIREMENTS:this.NOT_HAS_REQUIREMENTS;OT.checkSystemRequirements=function(){OT.debug("TB.checkSystemRequirements()");return c};return c};OT.upgradeSystemRequirements=function(){OT.onLoad(function(){document.body.appendChild(function(){var c=
document.createElement("iframe");c.id="_upgradeFlash";c.style.position="absolute";c.style.position="fixed";c.style.height="100%";c.style.width="100%";c.style.top="0px";c.style.left="0px";c.style.right="0px";c.style.bottom="0px";c.style.zIndex=1E3;try{c.style.backgroundColor="rgba(0,0,0,0.2)"}catch(a){c.style.backgroundColor="transparent",c.setAttribute("allowTransparency","true")}c.setAttribute("frameBorder","0");c.frameBorder="0";c.scrolling="no";c.setAttribute("scrolling","no");c.src=OT.properties.assetURL+
"/html/upgradeFlash.html#"+encodeURIComponent(document.location.href);return c}());c&&clearInterval(c);c=setInterval(function(){var c=document.location.hash,a=/^#?\d+&/;c!==e&&a.test(c)&&(e=c,"close_window"===c.replace(a,"")&&(document.body.removeChild(document.getElementById("_upgradeFlash")),document.location.hash=""))},100)})};OT.reportIssue=function(){OT.warn("ToDo: haven't yet implemented TB.reportIssue")};OT.components={};OT.sessions={};OT.rtc={};OT.APIKEY=function(){var c=document.getElementsByTagName("script"),
c=c[c.length-1],c=c.getAttribute("src")||c.src;return(c=c.match(/[\?\&]apikey=([^&]+)/i))?c[1]:""}();OT.HAS_REQUIREMENTS=1;OT.NOT_HAS_REQUIREMENTS=0;k.OT||(k.OT=OT);k.TB||(k.TB=OT)})(window);
(function(k){OT.Collection=function(c){var e=[],g={},a=c||"id";OT.$.eventing(this,!0);var d=function(a){this.trigger("update",a);this.trigger("update:"+a.target.id,a)}.bind(this),b=function(a,b){if(void 0!==g[a]){var c=g[a];delete g[a];g[b]=c}}.bind(this),h=function(a){this.remove(a.target,a.reason)}.bind(this);this.reset=function(){e.forEach(function(a){a.off("updated",d,this);a.off("destroyed",h,this);a.off("idUpdated",b,this)},this);e=[];g={}};this.destroy=function(){e.forEach(function(a){a.destroy(void 0,
!0)});this.reset();this.off()};this.get=function(a){return a&&void 0!==g[a]?e[g[a]]:void 0};this.has=function(a){return a&&void 0!==g[a]};this.toString=function(){return e.toString()};this.where=function(a,b){return OT.$.isFunction(a)?e.filter(a,b):e.filter(function(b){for(var c in a)if(b[c]!==a[c])return!1;return!0})};this.find=function(a,b){var c;c=OT.$.isFunction(a)?a:function(b){for(var c in a)if(b[c]!==a[c])return!1;return!0};c=c.bind(b);for(var d=0;d<e.length;++d)if(!0===c(e[d]))return e[d];
return null};this.add=function(c){var l=c[a];if(this.has(l))return OT.warn("Model "+l+" is already in the collection",e),this;g[l]=e.push(c)-1;c.on("updated",d,this);c.on("destroyed",h,this);c.on("idUpdated",b,this);this.trigger("add",c);this.trigger("add:"+l,c);return this};this.remove=function(c,l){var n=c[a];e.splice(g[n],1);for(var m=g[n];m<e.length;++m)g[e[m][a]]=m;delete g[n];c.off("updated",d,this);c.off("destroyed",h,this);c.off("idUpdated",b,this);this.trigger("remove",c,l);this.trigger("remove:"+
n,c,l);return this};OT.$.defineGetters(this,{length:function(){return e.length}})}})(this);
(function(k){OT.Event=OT.$.eventing.Event();OT.Event.names={ACTIVE:"active",INACTIVE:"inactive",UNKNOWN:"unknown",PER_SESSION:"perSession",PER_STREAM:"perStream",EXCEPTION:"exception",ISSUE_REPORTED:"issueReported",SESSION_CONNECTED:"sessionConnected",SESSION_DISCONNECTED:"sessionDisconnected",STREAM_CREATED:"streamCreated",STREAM_DESTROYED:"streamDestroyed",CONNECTION_CREATED:"connectionCreated",CONNECTION_DESTROYED:"connectionDestroyed",SIGNAL:"signal",STREAM_PROPERTY_CHANGED:"streamPropertyChanged",
MICROPHONE_LEVEL_CHANGED:"microphoneLevelChanged",RESIZE:"resize",SETTINGS_BUTTON_CLICK:"settingsButtonClick",DEVICE_INACTIVE:"deviceInactive",INVALID_DEVICE_NAME:"invalidDeviceName",ACCESS_ALLOWED:"accessAllowed",ACCESS_DENIED:"accessDenied",ACCESS_DIALOG_OPENED:"accessDialogOpened",ACCESS_DIALOG_CLOSED:"accessDialogClosed",ECHO_CANCELLATION_MODE_CHANGED:"echoCancellationModeChanged",PUBLISHER_DESTROYED:"destroyed",SUBSCRIBER_DESTROYED:"destroyed",DEVICES_DETECTED:"devicesDetected",DEVICES_SELECTED:"devicesSelected",
CLOSE_BUTTON_CLICK:"closeButtonClick",MICLEVEL:"microphoneActivityLevel",MICGAINCHANGED:"microphoneGainChanged",ENV_LOADED:"envLoaded"};OT.ValueEvent=function(c,e){OT.Event.call(this,c);this.value=e};OT.ExceptionCodes={JS_EXCEPTION:2E3,AUTHENTICATION_ERROR:1004,INVALID_SESSION_ID:1005,CONNECT_FAILED:1006,CONNECT_REJECTED:1007,CONNECTION_TIMEOUT:1008,NOT_CONNECTED:1010,P2P_CONNECTION_FAILED:1013,API_RESPONSE_FAILURE:1014,UNABLE_TO_PUBLISH:1500,UNABLE_TO_SIGNAL:1510,UNABLE_TO_FORCE_DISCONNECT:1520,
UNABLE_TO_FORCE_UNPUBLISH:1530};OT.ExceptionEvent=function(c,e,g,a,d,b){OT.Event.call(this,c);this.message=e;this.title=g;this.code=a;this.component=d;this.target=b};OT.IssueReportedEvent=function(c,e){OT.Event.call(this,c);this.issueId=e};OT.EnvLoadedEvent=function(c){OT.Event.call(this,c)};OT.ConnectionEvent=function(c,e,g){OT.Event.call(this,c);this.connections=e;this.reason=g};OT.StreamEvent=function(c,e,g,a){OT.Event.call(this,c,a);this.streams=e;this.reason=g};OT.SessionConnectEvent=function(c,
e,g,a){OT.Event.call(this,c);this.connections=e;this.streams=g;this.archives=a;this.groups=[]};OT.SessionDisconnectEvent=function(c,e,g){OT.Event.call(this,c,g);this.reason=e};OT.VolumeEvent=function(c,e,g){OT.Event.call(this,c);this.streamId=e;this.volume=g};OT.DeviceEvent=function(c,e,g){OT.Event.call(this,c);this.camera=e;this.microphone=g};OT.DeviceStatusEvent=function(c,e,g,a,d){OT.Event.call(this,c);this.cameras=e;this.microphones=g;this.selectedCamera=a;this.selectedMicrophone=d};OT.ResizeEvent=
function(c,e,g,a,d){OT.Event.call(this,c);this.widthFrom=e;this.widthTo=g;this.heightFrom=a;this.heightTo=d};OT.StreamPropertyChangedEvent=function(c,e,g,a,d){OT.Event.call(this,c);this.type=c;this.stream=e;this.changedProperty=g;this.oldValue=a;this.newValue=d};OT.ArchiveEvent=function(c,e){OT.Event.call(this,c);this.archives=e};OT.ArchiveStreamEvent=function(c,e,g){OT.Event.call(this,c);this.archive=e;this.streams=g};OT.StateChangedEvent=function(c,e){OT.Event.call(this,c);this.changedValues=e};
OT.ChangeFailedEvent=function(c,e,g,a){OT.Event.call(this,c);this.reasonCode=e;this.reason=g;this.failedValues=a};OT.SignalEvent=function(c,e,g){OT.Event.call(this,c?"signal:"+c:OT.Event.names.SIGNAL,!1);this.data=e;this.from=g};OT.StreamUpdatedEvent=function(c,e,g,a){OT.Event.call(this,"updated");this.target=c;this.changedProperty=e;this.oldValue=g;this.newValue=a};OT.DestroyedEvent=function(c,e,g){OT.Event.call(this,c,!1);this.target=e;this.reason=g}})(window);
(function(k){function c(a,c,b){return c<=a&&a<=b}function e(a,c){return Math.floor(a/c)}function g(a){var c=0;this.get=function(){return c>=a.length?-1:Number(a[c])};this.offset=function(b){c+=b;if(0>c)throw Error("Seeking past start of the buffer");if(c>a.length)throw Error("Seeking past EOF");};this.match=function(b){if(b.length>c+a.length)return!1;var d;for(d=0;d<b.length;d+=1)if(Number(a[c+d])!==b[d])return!1;return!0}}function a(a){var c=0;this.emit=function(b){var d=-1,e;for(e=0;e<arguments.length;++e)d=
Number(arguments[e]),a[c++]=d;return d}}function d(a){var b=0,d=function(a){for(var b=[],d=0,e=a.length;d<a.length;){var f=a.charCodeAt(d);if(c(f,55296,57343))if(c(f,56320,57343))b.push(65533);else if(d===e-1)b.push(65533);else{var h=a.charCodeAt(d+1);c(h,56320,57343)?(f&=1023,h&=1023,d+=1,b.push(65536+(f<<10)+h)):b.push(65533)}else b.push(f);d+=1}return b}(a);this.offset=function(a){b+=a;if(0>b)throw Error("Seeking past start of the buffer");if(b>d.length)throw Error("Seeking past EOF");};this.get=
function(){return b>=d.length?-1:d[b]}}function b(){var a="";this.string=function(){return a};this.emit=function(c){65535>=c?a+=String.fromCharCode(c):(c-=65536,a+=String.fromCharCode(55296+(c>>10&1023)),a+=String.fromCharCode(56320+(c&1023)))}}function h(a){this.name="EncodingError";this.message=a;this.code=0}function f(a,c){if(a)throw new h("Decoder error");return c||65533}function l(a){throw new h("The code point "+a+" could not be encoded.");}function n(a){a=String(a).trim().toLowerCase();return Object.prototype.hasOwnProperty.call(L,
a)?L[a]:null}function m(a,c){return(c||[])[a]||null}function r(a,c){var b=c.indexOf(a);return-1===b?null:b}function q(a){var b=a.fatal,d=0,e=0,h=0,g=0;this.decode=function(a){var l=a.get();if(-1===l)return 0!==e?f(b):-1;a.offset(1);if(0===e){if(c(l,0,127))return l;if(c(l,194,223))e=1,g=128,d=l-192;else if(c(l,224,239))e=2,g=2048,d=l-224;else if(c(l,240,244))e=3,g=65536,d=l-240;else return f(b);d*=Math.pow(64,e);return null}if(!c(l,128,191))return g=h=e=d=0,a.offset(-1),f(b);h+=1;d+=(l-128)*Math.pow(64,
e-h);if(h!==e)return null;a=d;l=g;g=h=e=d=0;return c(a,l,1114111)&&!c(a,55296,57343)?a:f(b)}}function t(a){this.encode=function(a,b){var d=b.get();if(-1===d)return-1;b.offset(1);if(c(d,55296,57343))return l(d);if(c(d,0,127))return a.emit(d);var f,h;c(d,128,2047)?(f=1,h=192):c(d,2048,65535)?(f=2,h=224):c(d,65536,1114111)&&(f=3,h=240);for(h=a.emit(e(d,Math.pow(64,f))+h);0<f;)h=e(d,Math.pow(64,f-1)),h=a.emit(128+h%64),f-=1;return h}}function p(a,b){var d=b.fatal;this.decode=function(b){var e=b.get();
if(-1===e)return-1;b.offset(1);if(c(e,0,127))return e;b=a[e-128];return null===b?f(d):b}}function s(a,b){this.encode=function(b,d){var e=d.get();if(-1===e)return-1;d.offset(1);if(c(e,0,127))return b.emit(e);var f=r(e,a);null===f&&l(e);return b.emit(f+128)}}function u(a,b){var d=b.fatal,e=0,h=0,g=0;this.decode=function(b){var l=b.get();if(-1===l&&0===e&&0===h&&0===g)return-1;if(-1===l&&(0!==e||0!==h||0!==g))g=h=e=0,f(d);b.offset(1);var v;if(0!==g){v=null;if(c(l,48,57))if(l=10*(126*(10*(e-129)+(h-48))+
(g-129))+l-48,39419<l&&189E3>l||1237575<l)v=null;else{var n=0;v=0;var F=A.gb18030,k;for(k=0;k<F.length;++k){var H=F[k];if(H[0]<=l)n=H[0],v=H[1];else break}v=v+l-n}g=h=e=0;return null===v?(b.offset(-3),f(d)):v}if(0!==h){if(c(l,129,254))return g=l,null;b.offset(-2);h=e=0;return f(d)}if(0!==e){if(c(l,48,57)&&a)return h=l,null;v=e;n=null;e=0;F=127>l?64:65;if(c(l,64,126)||c(l,128,254))n=190*(v-129)+(l-F);v=null===n?null:m(n,A.gbk);null===n&&b.offset(-1);return null===v?f(d):v}return c(l,0,127)?l:128===
l?8364:c(l,129,254)?(e=l,null):f(d)}}function w(a,b){this.encode=function(b,d){var f=d.get();if(-1===f)return-1;d.offset(1);if(c(f,0,127))return b.emit(f);var h=r(f,A.gbk);if(null!==h)return f=e(h,190)+129,h%=190,b.emit(f,h+(63>h?64:65));if(null===h&&!a)return l(f);var g=h=0,m=A.gb18030,v;for(v=0;v<m.length;++v){var n=m[v];if(n[1]<=f)h=n[1],g=n[0];else break}h=g+f-h;f=e(e(e(h,10),126),10);h-=12600*f;g=e(e(h,10),126);h-=1260*g;m=e(h,10);return b.emit(f+129,g+48,m+129,h-10*m+48)}}function x(a){var b=
a.fatal,d=!1,e=0;this.decode=function(a){var h=a.get();if(-1===h&&0===e)return-1;if(-1===h&&0!==e)return e=0,f(b);a.offset(1);if(126===e){e=0;if(123===h)return d=!0,null;if(125===h)return d=!1,null;if(126===h)return 126;if(10===h)return null;a.offset(-1);return f(b)}if(0!==e){a=e;e=0;var g=null;c(h,33,126)&&(g=m(190*(a-1)+(h+63),A.gbk));10===h&&(d=!1);return null===g?f(b):g}if(126===h)return e=126,null;if(d){if(c(h,32,127))return e=h,null;10===h&&(d=!1);return f(b)}return c(h,0,127)?h:f(b)}}function y(a){var b=
!1;this.encode=function(a,d){var f=d.get();if(-1===f)return-1;d.offset(1);if(c(f,0,127)&&b)return d.offset(-1),b=!1,a.emit(126,125);if(126===f)return a.emit(126,126);if(c(f,0,127))return a.emit(f);if(!b)return d.offset(-1),b=!0,a.emit(126,123);var h=r(f,A.gbk);if(null===h)return l(f);var g=e(h,190)+1,h=h%190-63;return!c(g,33,126)||!c(h,33,126)?l(f):a.emit(g,h)}}function B(a){var b=a.fatal,d=0,e=null;this.decode=function(a){if(null!==e)return a=e,e=null,a;var h=a.get();if(-1===h&&0===d)return-1;if(-1===
h&&0!==d)return d=0,f(b);a.offset(1);if(0!==d){var g=d,l=null;d=0;var v=127>h?64:98;if(c(h,64,126)||c(h,161,254))l=157*(g-129)+(h-v);if(1133===l)return e=772,202;if(1135===l)return e=780,202;if(1164===l)return e=772,234;if(1166===l)return e=780,234;h=null===l?null:m(l,A.big5);null===l&&a.offset(-1);return null===h?f(b):h}return c(h,0,127)?h:c(h,129,254)?(d=h,null):f(b)}}function D(a){this.encode=function(a,b){var d=b.get();if(-1===d)return-1;b.offset(1);if(c(d,0,127))return a.emit(d);var f=r(d,A.big5);
if(null===f)return l(d);d=e(f,157)+129;f%=157;return a.emit(d,f+(63>f?64:98))}}function G(a){var b=a.fatal,d=0,e=0;this.decode=function(a){var h=a.get();if(-1===h){if(0===d&&0===e)return-1;e=d=0;return f(b)}a.offset(1);var g,l;return 0!==e?(g=e,e=0,l=null,c(g,161,254)&&c(h,161,254)&&(l=m(94*(g-161)+h-161,A.jis0212)),c(h,161,254)||a.offset(-1),null===l?f(b):l):142===d&&c(h,161,223)?(d=0,65377+h-161):143===d&&c(h,161,254)?(d=0,e=h,null):0!==d?(g=d,d=0,l=null,c(g,161,254)&&c(h,161,254)&&(l=m(94*(g-161)+
h-161,A.jis0208)),c(h,161,254)||a.offset(-1),null===l?f(b):l):c(h,0,127)?h:142===h||143===h||c(h,161,254)?(d=h,null):f(b)}}function E(a){this.encode=function(a,b){var d=b.get();if(-1===d)return-1;b.offset(1);if(c(d,0,127))return a.emit(d);if(165===d)return a.emit(92);if(8254===d)return a.emit(126);if(c(d,65377,65439))return a.emit(142,d-65377+161);var f=r(d,A.jis0208);if(null===f)return l(d);d=e(f,94)+161;return a.emit(d,f%94+161)}}function C(a){var b=a.fatal,d=0,e=!1,h=0;this.decode=function(a){var g=
a.get();-1!==g&&a.offset(1);switch(d){default:case 0:return 27===g?(d=1,null):c(g,0,127)?g:-1===g?-1:f(b);case 1:if(36===g||40===g)return h=g,d=2,null;-1!==g&&a.offset(-1);d=0;return f(b);case 2:var l=h;h=0;if(36===l&&(64===g||66===g))return e=!1,d=4,null;if(36===l&&40===g)return d=3,null;if(40===l&&(66===g||74===g))return d=0,null;if(40===l&&73===g)return d=6,null;-1===g?a.offset(-1):a.offset(-2);d=0;return f(b);case 3:if(68===g)return e=!0,d=4,null;-1===g?a.offset(-2):a.offset(-3);d=0;return f(b);
case 4:if(10===g)return d=0,f(b,10);if(27===g)return d=1,null;if(-1===g)return-1;h=g;d=5;return null;case 5:d=4;if(-1===g)return f(b);a=null;l=94*(h-33)+g-33;c(h,33,126)&&c(g,33,126)&&(a=!1===e?m(l,A.jis0208):m(l,A.jis0212));return null===a?f(b):a;case 6:return 27===g?(d=1,null):c(g,33,95)?65377+g-33:-1===g?-1:f(b)}}}function v(a){var b=0;this.encode=function(a,d){var f=d.get();if(-1===f)return-1;d.offset(1);if((c(f,0,127)||165===f||8254===f)&&0!==b)return d.offset(-1),b=0,a.emit(27,40,66);if(c(f,
0,127))return a.emit(f);if(165===f)return a.emit(92);if(8254===f)return a.emit(126);if(c(f,65377,65439)&&2!==b)return d.offset(-1),b=2,a.emit(27,40,73);if(c(f,65377,65439))return a.emit(f-65377-33);if(1!==b)return d.offset(-1),b=1,a.emit(27,36,66);var h=r(f,A.jis0208);if(null===h)return l(f);f=e(h,94)+33;return a.emit(f,h%94+33)}}function F(a){var b=a.fatal,d=0;this.decode=function(a){var e=a.get();if(-1===e&&0===d)return-1;if(-1===e&&0!==d)return d=0,f(b);a.offset(1);if(0!==d){var h=d;d=0;if(c(e,
64,126)||c(e,128,252))return a=m(188*(h-(160>h?129:193))+e-(127>e?64:65),A.jis0208),null===a?f(b):a;a.offset(-1);return f(b)}return c(e,0,128)?e:c(e,161,223)?65377+e-161:c(e,129,159)||c(e,224,252)?(d=e,null):f(b)}}function H(a){this.encode=function(a,b){var d=b.get();if(-1===d)return-1;b.offset(1);if(c(d,0,128))return a.emit(d);if(165===d)return a.emit(92);if(8254===d)return a.emit(126);if(c(d,65377,65439))return a.emit(d-65377+161);var f=r(d,A.jis0208);if(null===f)return l(d);d=e(f,188);f%=188;return a.emit(d+
(31>d?129:193),f+(63>f?64:65))}}function I(a){var b=a.fatal,d=0;this.decode=function(a){var e=a.get();if(-1===e&&0===d)return-1;if(-1===e&&0!==d)return d=0,f(b);a.offset(1);if(0!==d){var h=d,g=null;d=0;if(c(h,129,198)){var l=178*(h-129);c(e,65,90)?g=l+e-65:c(e,97,122)?g=l+26+e-97:c(e,129,254)&&(g=l+26+26+e-129)}c(h,199,253)&&c(e,161,254)&&(g=12460+94*(h-199)+(e-161));e=null===g?null:m(g,A["euc-kr"]);null===g&&a.offset(-1);return null===e?f(b):e}return c(e,0,127)?e:c(e,129,253)?(d=e,null):f(b)}}function M(a){this.encode=
function(a,b){var d=b.get();if(-1===d)return-1;b.offset(1);if(c(d,0,127))return a.emit(d);var f=r(d,A["euc-kr"]);if(null===f)return l(d);if(12460>f)return d=e(f,178)+129,f%=178,a.emit(d,f+(26>f?65:52>f?71:77));f-=12460;d=e(f,94)+199;return a.emit(d,f%94+161)}}function N(a){var d=a.fatal,b=0,e=0;this.decode=function(a){var h=a.get();-1!==h&&a.offset(1);switch(b){default:case 0:return 14===h?(b=4,null):15===h?null:27===h?(b=1,null):c(h,0,127)?h:-1===h?-1:f(d);case 1:if(36===h)return b=2,null;-1!==h&&
a.offset(-1);b=0;return f(d);case 2:if(41===h)return b=3,null;-1===h?a.offset(-1):a.offset(-2);b=0;return f(d);case 3:if(67===h)return b=0,null;-1===h?a.offset(-2):a.offset(-3);b=0;return f(d);case 4:if(10===h)return b=0,f(d,10);if(14===h)return null;if(15===h)return b=0,null;if(-1===h)return-1;e=h;b=5;return null;case 5:b=4;if(-1===h)return f(d);a=null;c(e,33,70)&&c(h,33,126)?a=m(178*(e-1)+52+h-1,A["euc-kr"]):c(e,71,126)&&c(h,33,126)&&(a=m(12460+94*(e-71)+(h-33),A["euc-kr"]));return null!==a?a:f(d)}}}
function O(a){var b=!1,d=0;this.encode=function(a,f){var h=f.get();if(-1===h)return-1;b||(b=!0,a.emit(27,36,41,67));f.offset(1);if(c(h,0,127)&&0!==d)return f.offset(-1),d=0,a.emit(15);if(c(h,0,127))return a.emit(h);if(1!==d)return f.offset(-1),d=1,a.emit(14);var g=r(h,A["euc-kr"]);if(null===g)return l(h);var m;if(12460>g)return m=e(g,178)+1,g=g%178-26-26+1,!c(m,33,70)||!c(g,33,126)?l(h):a.emit(m,g);g-=12460;m=e(g,94)+71;g=g%94+33;return!c(m,71,126)||!c(g,33,126)?l(h):a.emit(m,g)}}function K(a,d){var b=
d.fatal,e=null,h=null;this.decode=function(d){var g=d.get();if(-1===g&&null===e&&null===h)return-1;if(-1===g&&(null!==e||null!==h))return f(b);d.offset(1);if(null===e)return e=g,null;g=a?(e<<8)+g:(g<<8)+e;e=null;if(null!==h){var l=h;h=null;if(c(g,56320,57343))return 65536+1024*(l-55296)+(g-56320);d.offset(-2);return f(b)}return c(g,55296,56319)?(h=g,null):c(g,56320,57343)?f(b):g}}function J(a,d){this.encode=function(d,b){function f(b){var c=b>>8;b&=255;return a?d.emit(c,b):d.emit(b,c)}var h=b.get();
if(-1===h)return-1;b.offset(1);c(h,55296,57343)&&l(h);if(65535>=h)return f(h);var g=e(h-65536,1024)+55296,h=(h-65536)%1024+56320;f(g);return f(h)}}function P(a,b){if(!this||this===k)return new P(a,b);a=a?String(a):"utf-8";b=Object(b);this._encoding=n(a);if(null===this._encoding||"utf-8"!==this._encoding.name&&"utf-16"!==this._encoding.name&&"utf-16be"!==this._encoding.name)throw new TypeError("Unknown encoding: "+a);this._streaming=!1;this._encoder=null;this._options={fatal:Boolean(b.fatal)};Object.defineProperty?
Object.defineProperty(this,"encoding",{get:function(){return this._encoding.name}}):this.encoding=this._encoding.name;return this}function Q(a,b){if(!this||this===k)return new Q(a,b);a=a?String(a):"utf-8";b=Object(b);this._encoding=n(a);if(null===this._encoding)throw new TypeError("Unknown encoding: "+a);this._streaming=!1;this._decoder=null;this._options={fatal:Boolean(b.fatal)};Object.defineProperty?Object.defineProperty(this,"encoding",{get:function(){return this._encoding.name}}):this.encoding=
this._encoding.name;return this}if(!(void 0!==k.TextEncoder&&void 0!==k.TextDecoder)){h.prototype=Error.prototype;var z={},L={};[{encodings:[{labels:["unicode-1-1-utf-8","utf-8","utf8"],name:"utf-8"}],heading:"The Encoding"},{encodings:[{labels:["cp864","ibm864"],name:"ibm864"},{labels:["cp866","ibm866"],name:"ibm866"},{labels:"csisolatin2 iso-8859-2 iso-ir-101 iso8859-2 iso_8859-2 l2 latin2".split(" "),name:"iso-8859-2"},{labels:"csisolatin3 iso-8859-3 iso_8859-3 iso-ir-109 l3 latin3".split(" "),
name:"iso-8859-3"},{labels:"csisolatin4 iso-8859-4 iso_8859-4 iso-ir-110 l4 latin4".split(" "),name:"iso-8859-4"},{labels:["csisolatincyrillic","cyrillic","iso-8859-5","iso_8859-5","iso-ir-144"],name:"iso-8859-5"},{labels:"arabic csisolatinarabic ecma-114 iso-8859-6 iso_8859-6 iso-ir-127".split(" "),name:"iso-8859-6"},{labels:"csisolatingreek ecma-118 elot_928 greek greek8 iso-8859-7 iso_8859-7 iso-ir-126".split(" "),name:"iso-8859-7"},{labels:"csisolatinhebrew hebrew iso-8859-8 iso-8859-8-i iso-ir-138 iso_8859-8 visual".split(" "),
name:"iso-8859-8"},{labels:"csisolatin6 iso-8859-10 iso-ir-157 iso8859-10 l6 latin6".split(" "),name:"iso-8859-10"},{labels:["iso-8859-13"],name:"iso-8859-13"},{labels:["iso-8859-14","iso8859-14"],name:"iso-8859-14"},{labels:["iso-8859-15","iso_8859-15"],name:"iso-8859-15"},{labels:["iso-8859-16"],name:"iso-8859-16"},{labels:["koi8-r","koi8_r"],name:"koi8-r"},{labels:["koi8-u"],name:"koi8-u"},{labels:["csmacintosh","mac","macintosh","x-mac-roman"],name:"macintosh"},{labels:["iso-8859-11","tis-620",
"windows-874"],name:"windows-874"},{labels:["windows-1250","x-cp1250"],name:"windows-1250"},{labels:["windows-1251","x-cp1251"],name:"windows-1251"},{labels:"ascii ansi_x3.4-1968 csisolatin1 iso-8859-1 iso8859-1 iso_8859-1 l1 latin1 us-ascii windows-1252".split(" "),name:"windows-1252"},{labels:["cp1253","windows-1253"],name:"windows-1253"},{labels:"csisolatin5 iso-8859-9 iso-ir-148 l5 latin5 windows-1254".split(" "),name:"windows-1254"},{labels:["cp1255","windows-1255"],name:"windows-1255"},{labels:["cp1256",
"windows-1256"],name:"windows-1256"},{labels:["windows-1257"],name:"windows-1257"},{labels:["cp1258","windows-1258"],name:"windows-1258"},{labels:["x-mac-cyrillic","x-mac-ukrainian"],name:"x-mac-cyrillic"}],heading:"Legacy single-byte encodings"},{encodings:[{labels:"chinese csgb2312 csiso58gb231280 gb2312 gbk gb_2312 gb_2312-80 iso-ir-58 x-gbk".split(" "),name:"gbk"},{labels:["gb18030"],name:"gb18030"},{labels:["hz-gb-2312"],name:"hz-gb-2312"}],heading:"Legacy multi-byte Chinese (simplified) encodings"},
{encodings:[{labels:["big5","big5-hkscs","cn-big5","csbig5","x-x-big5"],name:"big5"}],heading:"Legacy multi-byte Chinese (traditional) encodings"},{encodings:[{labels:["cseucpkdfmtjapanese","euc-jp","x-euc-jp"],name:"euc-jp"},{labels:["csiso2022jp","iso-2022-jp"],name:"iso-2022-jp"},{labels:"csshiftjis ms_kanji shift-jis shift_jis sjis windows-31j x-sjis".split(" "),name:"shift_jis"}],heading:"Legacy multi-byte Japanese encodings"},{encodings:[{labels:"cseuckr csksc56011987 euc-kr iso-ir-149 korean ks_c_5601-1987 ks_c_5601-1989 ksc5601 ksc_5601 windows-949".split(" "),
name:"euc-kr"},{labels:["csiso2022kr","iso-2022-kr"],name:"iso-2022-kr"}],heading:"Legacy multi-byte Korean encodings"},{encodings:[{labels:["utf-16","utf-16le"],name:"utf-16"},{labels:["utf-16be"],name:"utf-16be"}],heading:"Legacy utf-16 encodings"}].forEach(function(a){a.encodings.forEach(function(a){z[a.name]=a;a.labels.forEach(function(b){L[b]=a})})});var A=k["encoding-indexes"]||{};z["utf-8"].getEncoder=function(a){return new t(a)};z["utf-8"].getDecoder=function(a){return new q(a)};(function(){"ibm864 ibm866 iso-8859-2 iso-8859-3 iso-8859-4 iso-8859-5 iso-8859-6 iso-8859-7 iso-8859-8 iso-8859-10 iso-8859-13 iso-8859-14 iso-8859-15 iso-8859-16 koi8-r koi8-u macintosh windows-874 windows-1250 windows-1251 windows-1252 windows-1253 windows-1254 windows-1255 windows-1256 windows-1257 windows-1258 x-mac-cyrillic".split(" ").forEach(function(a){var b=
z[a],d=A[a];b.getDecoder=function(a){return new p(d,a)};b.getEncoder=function(a){return new s(d,a)}})})();z.gbk.getEncoder=function(a){return new w(!1,a)};z.gbk.getDecoder=function(a){return new u(!1,a)};z.gb18030.getEncoder=function(a){return new w(!0,a)};z.gb18030.getDecoder=function(a){return new u(!0,a)};z["hz-gb-2312"].getEncoder=function(a){return new y(a)};z["hz-gb-2312"].getDecoder=function(a){return new x(a)};z.big5.getEncoder=function(a){return new D(a)};z.big5.getDecoder=function(a){return new B(a)};
z["euc-jp"].getEncoder=function(a){return new E(a)};z["euc-jp"].getDecoder=function(a){return new G(a)};z["iso-2022-jp"].getEncoder=function(a){return new v(a)};z["iso-2022-jp"].getDecoder=function(a){return new C(a)};z.shift_jis.getEncoder=function(a){return new H(a)};z.shift_jis.getDecoder=function(a){return new F(a)};z["euc-kr"].getEncoder=function(a){return new M(a)};z["euc-kr"].getDecoder=function(a){return new I(a)};z["iso-2022-kr"].getEncoder=function(a){return new O(a)};z["iso-2022-kr"].getDecoder=
function(a){return new N(a)};z["utf-16"].getEncoder=function(a){return new J(!1,a)};z["utf-16"].getDecoder=function(a){return new K(!1,a)};z["utf-16be"].getEncoder=function(a){return new J(!0,a)};z["utf-16be"].getDecoder=function(a){return new K(!0,a)};P.prototype={encode:function(b,c){b=b?String(b):"";c=Object(c);this._streaming||(this._encoder=this._encoding.getEncoder(this._options));this._streaming=Boolean(c.stream);for(var e=[],f=new a(e),h=new d(b);-1!==h.get();)this._encoder.encode(f,h);if(!this._streaming){var g;
do g=this._encoder.encode(f,h);while(-1!==g);this._encoder=null}return new Uint8Array(e)}};Q.prototype={decode:function(a,d){if(a&&!("buffer"in a&&"byteOffset"in a&&"byteLength"in a))throw new TypeError("Expected ArrayBufferView");a||(a=new Uint8Array(0));d=Object(d);this._streaming||(this._decoder=this._encoding.getDecoder(this._options));this._streaming=Boolean(d.stream);var c=new Uint8Array(a.buffer,a.byteOffset,a.byteLength),c=new g(c);if(!this._BOMseen){this._BOMseen=!0;var e=this._encoding.name;
c.match([255,254])&&"utf-16"===e?c.offset(2):c.match([254,255])&&"utf-16be"==e?c.offset(2):c.match([239,187,191])&&"utf-8"==e&&c.offset(3)}for(var e=new b,f;-1!==c.get();)f=this._decoder.decode(c),null!==f&&-1!==f&&e.emit(f);if(!this._streaming){do f=this._decoder.decode(c),null!==f&&-1!==f&&e.emit(f);while(-1!==f&&-1!=c.get());this._decoder=null}return e.string()}};k.TextEncoder=k.TextEncoder||P;k.TextDecoder=k.TextDecoder||Q}})(this);
(function(k){OT.Rumor={MessageType:{SUBSCRIBE:0,UNSUBSCRIBE:1,MESSAGE:2,CONNECT:3,DISCONNECT:4,PING:7,PONG:8,STATUS:9}}})(this);
(function(k){var c={1002:"The endpoint is terminating the connection due to a protocol error. (CLOSE_PROTOCOL_ERROR)",1003:"The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data). (CLOSE_UNSUPPORTED)",1004:"The endpoint is terminating the connection because a data frame was received that is too large. (CLOSE_TOO_LARGE)",1005:"Indicates that no status code was provided even though one was expected. (CLOSE_NO_STATUS)",
1006:"Used to indicate that a connection was closed abnormally (that is, with no close frame being sent) when a status code is expected. (CLOSE_ABNORMAL)",1007:"Indicates that an endpoint is terminating the connection because it has received data within a message that was not consistent with the type of the message (e.g., non-UTF-8 [RFC3629] data within a text message)",1008:"Indicates that an endpoint is terminating the connection because it has received a message that violates its policy.  This is a generic status code that can be returned when there is no other more suitable status code (e.g., 1003 or 1009) or if there is a need to hide specific details about the policy",
1009:"Indicates that an endpoint is terminating the connection because it has received a message that is too big for it to process",1011:"Indicates that a server is terminating the connection because it encountered an unexpected condition that prevented it from fulfilling the request",4001:"Connectivity loss was detected as it was too long since the socket received the last PONG message"};OT.Rumor.SocketError=function(c,g){this.code=c;this.message=g};OT.Rumor.Socket=function(e,g,a){var d,b,h,f,l,
n,m,k,q,t,p,s=OT.$.statable(this,["disconnected","error","connected","connecting","disconnecting"],"disconnected",function(a){switch(a){case "disconnected":case "error":if(d=null,l){var b;if(!t?0:44900<=OT.$.now()-t)b=Error(c[4001]),b.code=4001;l(b)}}}),u=function(a,b){if(null===b||!OT.$.isFunction(b))throw Error("The Rumor.Socket "+a+" callback must be a valid function or null");},w=function(a){OT.error("Rumor.Socket: "+a);a=new OT.Rumor.SocketError(null,a||"Unknown Socket Error");q&&clearTimeout(q);
s("error");"connecting"===this.previousState&&m&&(m(a,null),m=null);f&&f(a)}.bind(this),x=function F(a){d&&(void 0===a&&(a=0),k&&clearTimeout(k),0<d.bufferedAmount&&10>=a+1?k=setTimeout(F,100,a+1):(s("disconnecting"),k&&(clearTimeout(k),k=null),console.info("CALLED CLOSE ON WEBSOCKET"),d.close()))},y=function H(){this.is("connected")&&((!t?0:44900<=OT.$.now()-t)?E({code:4001}):(d.send(OT.Rumor.Message.Ping().serialize()),p=setTimeout(H.bind(this),9E3)))}.bind(this),B=function(){q&&clearTimeout(q);
d.send(OT.Rumor.Message.Connect(b,g).serialize());s("connected");m&&(m(null,b),m=null);h&&h(b);setTimeout(function(){t=OT.$.now();y()},9E3)},D=function(){w("Timed out while waiting for the Rumor socket to connect.")},G=function(a){},E=function(a){q&&clearTimeout(q);p&&clearTimeout(p);if(1E3!==a.code&&1001!==a.code){var b=a.reason||a.message;!b&&c.hasOwnProperty(a.code)&&(b=c[a.code]);w("Rumor Socket Disconnected: "+b)}this.isNot("error")&&s("disconnected")}.bind(this),C=function(a){t=OT.$.now();n&&
(a=OT.Rumor.Message.deserialize(a.data),a.type!==OT.Rumor.MessageType.PONG&&n(a.toAddress,a.data))};this.publish=function(a,b){d.send(OT.Rumor.Message.Publish(a,b).serialize())};this.subscribe=function(a){d.send(OT.Rumor.Message.Subscribe(a).serialize())};this.unsubscribe=function(a){d.send(OT.Rumor.Message.Unsubscribe(a).serialize())};this.connect=function(c,f){if(this.is("connecting","connected"))f(new OT.Rumor.SocketError(null,"Rumor.Socket cannot connect when it is already connecting or connected."));
else{b=c;m=f;try{s("connecting"),d=new (a||WebSocket)(e),d.binaryType="arraybuffer",d.onopen=B,d.onclose=E,d.onerror=G,d.onmessage=C,q=setTimeout(D,OT.Rumor.Socket.CONNECT_TIMEOUT)}catch(h){OT.error(h),w("Could not connect to the Rumor socket, possibly because of a blocked port.")}}};this.disconnect=function(){q&&clearTimeout(q);p&&clearTimeout(p);d?3===d.readyState?this.isNot("error")&&s("disconnected"):(this.is("connected")&&d.send(OT.Rumor.Message.Disconnect().serialize()),x()):this.isNot("error")&&
s("disconnected")};Object.defineProperties(this,{id:{get:function(){return b}},onOpen:{set:function(a){u("onOpen",a);h=a},get:function(){return h}},onError:{set:function(a){u("onError",a);f=a},get:function(){return f}},onClose:{set:function(a){u("onClose",a);l=a},get:function(){return l}},onMessage:{set:function(a){u("onMessage",a);n=a},get:function(){return n}}})};OT.Rumor.Socket.CONNECT_TIMEOUT=15E3})(this);
(function(k){OT.Rumor.Message=function(c,e,g,a){this.type=c;this.toAddress=e;this.headers=g;this.data=a};OT.Rumor.Message.prototype.serialize=function(){var c=8,e=7,g=Array(this.toAddress.length),a=Array(this.headers.length),d=Array(this.headers.length),b;e++;for(var h=0;h<this.toAddress.length;h++)g[h]=TextEncoder("utf-8").encode(this.toAddress[h]),e+=2,e+=g[h].length;e++;for(h=0;h<this.headers.length;h++)a[h]=TextEncoder("utf-8").encode(this.headers[h].key),d[h]=TextEncoder("utf-8").encode(this.headers[h].val),
e+=4,e+=a[h].length,e+=d[h].length;b=TextEncoder("utf-8").encode(this.data);var e=e+b.length,f=new ArrayBuffer(e),l=new Uint8Array(f,0,e),e=e-4;l[0]=(e&4278190080)>>>24;l[1]=(e&16711680)>>>16;l[2]=(e&65280)>>>8;l[3]=(e&255)>>>0;l[4]=0;l[5]=0;l[6]=this.type;l[7]=this.toAddress.length;for(h=0;h<g.length;h++){strArray=g[h];l[c++]=strArray.length>>8&255;l[c++]=strArray.length>>0&255;for(e=0;e<strArray.length;e++)l[c++]=strArray[e]}l[c++]=a.length;for(h=0;h<a.length;h++){strArray=a[h];l[c++]=strArray.length>>
8&255;l[c++]=strArray.length>>0&255;for(e=0;e<strArray.length;e++)l[c++]=strArray[e];strArray=d[h];l[c++]=strArray.length>>8&255;l[c++]=strArray.length>>0&255;for(e=0;e<strArray.length;e++)l[c++]=strArray[e]}for(h=0;h<b.length;h++)l[c++]=b[h];return f};OT.Rumor.Message.deserialize=function(c){var e,g=8,a=new Uint8Array(c);e=a[6];for(var d=[],b=0;b<a[7];b++){length=a[g++]<<8;length+=a[g++];var h=new Uint8Array(c,g,length);d[b]=TextDecoder("utf-8").decode(h);g+=length}for(var f=a[g++],l=[],b=0;b<f;b++){length=
a[g++]<<8;length+=a[g++];var h=new Uint8Array(c,g,length),n=TextDecoder("utf-8").decode(h),g=g+length;length=a[g++]<<8;length+=a[g++];h=new Uint8Array(c,g,length);h=TextDecoder("utf-8").decode(h);l[b]={key:n,val:h};g+=length}c=new Uint8Array(c,g);c=TextDecoder("utf-8").decode(c);return new OT.Rumor.Message(e,d,l,c)};OT.Rumor.Message.Connect=function(c,e){return new OT.Rumor.Message(OT.Rumor.MessageType.CONNECT,[],[{key:"uniqueId",val:c},{key:"notifyDisconnectAddress",val:e}],"")};OT.Rumor.Message.Disconnect=
function(){return new OT.Rumor.Message(OT.Rumor.MessageType.DISCONNECT,[],[],"")};OT.Rumor.Message.Subscribe=function(c){return new OT.Rumor.Message(OT.Rumor.MessageType.SUBSCRIBE,c,[],"")};OT.Rumor.Message.Unsubscribe=function(c){return new OT.Rumor.Message(OT.Rumor.MessageType.UNSUBSCRIBE,c,[],"")};OT.Rumor.Message.Publish=function(c,e,g){return new OT.Rumor.Message(OT.Rumor.MessageType.MESSAGE,c,[],e)};OT.Rumor.Message.Ping=function(){return new OT.Rumor.Message(OT.Rumor.MessageType.PING,[],[],
"")}})(this);
(function(k){OT.Raptor={Actions:{CONNECT:100,CREATE:101,UPDATE:102,DELETE:103,STATE:104,FORCE_DISCONNECT:105,FORCE_UNPUBLISH:106,SIGNAL:107,CREATE_ARCHIVE:108,CLOSE_ARCHIVE:109,START_RECORDING_SESSION:110,STOP_RECORDING_SESSION:111,START_RECORDING_STREAM:112,STOP_RECORDING_STREAM:113,LOAD_ARCHIVE:114,START_PLAYBACK:115,STOP_PLAYBACK:116,APPSTATE_PUT:117,APPSTATE_DELETE:118,OFFER:119,ANSWER:120,PRANSWER:121,CANDIDATE:122,SUBSCRIBE:123,UNSUBSCRIBE:124,QUERY:125,SDP_ANSWER:126,PONG:127,REGISTER:128,
QUALITY_CHANGED:129},Types:{RPC_REQUEST:100,RPC_RESPONSE:101,STREAM:102,ARCHIVE:103,CONNECTION:104,APPSTATE:105,CONNECTIONCOUNT:106,MODERATION:107,SIGNAL:108,SUBSCRIBER:110,JSEP:109}}})(this);
(function(k){var c={},e={};k=OT.Raptor.Types;for(var g in k)c[k[g]]=g;k=OT.Raptor.Actions;for(g in k)e[k[g]]=g;OT.Raptor.serializeMessage=function(a){return JSON.stringify(a)};OT.Raptor.deserializeMessage=function(a){a=JSON.parse(a);a.type&&(a.type=parseInt(a.type,10),a.typeName=c[a.type]||null);a.action&&(a.action=parseInt(a.action,10),a.actionName=e[a.action]||null);a.signature=a.typeName+":"+a.actionName;return a};OT.Raptor.Message={};OT.Raptor.Message.connect=function(a,d,b,c,e,g){a={credentials:{connectionId:d,
soAccessState:2,supportsWebRTC:!0,p2pEnabled:g,GUID:a,widgetId:a,partnerId:c},sessionId:b,params:{tokenPermissions:{apiKey:c},token:e},uniqueId:d};return OT.Raptor.serializeMessage({id:OT.$.uuid(),type:OT.Raptor.Types.RPC_REQUEST,action:OT.Raptor.Actions.CONNECT,payload:a,replyTo:d})};OT.Raptor.Message.getSessionState=function(a,d,b){return OT.Raptor.serializeMessage({id:OT.$.uuid(),type:OT.Raptor.Types.RPC_REQUEST,action:OT.Raptor.Actions.STATE,payload:{sessionId:d,connectionsRequired:b||!0},replyTo:a})};
OT.Raptor.Message.forceDisconnect=function(a,d,b){return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.RPC_REQUEST,action:OT.Raptor.Actions.FORCE_DISCONNECT,payload:{connectionId:d,sessionId:b},replyTo:a})};OT.Raptor.Message.streamCreate=function(a,d,b,c,e,g,n,m,k,q){d={key:d,value:{p2pEnabled:q||!1,publisherId:b,connection:{connectionId:a},type:"WebRTC",name:c||"",creationTime:Date.now(),orientation:{width:g,height:n,videoOrientation:e||"OTVideoOrientationRotatedNormal"},hasAudio:void 0!==
m?m:!0,hasVideo:void 0!==k?k:!0}};return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.STREAM,action:OT.Raptor.Actions.CREATE,payload:d,replyTo:""})};OT.Raptor.Message.streamDestroy=function(a,d,b){return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.STREAM,action:OT.Raptor.Actions.DELETE,payload:{key:d+"/STREAMS/"+b},replyTo:a})};OT.Raptor.Message.streamModify=function(a,d,b,c,e){return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.STREAM,action:OT.Raptor.Actions.UPDATE,payload:{key:[d,
"STREAMS",b,c].join("/"),value:e},replyTo:a})};OT.Raptor.Message.forceUnpublish=function(a,d,b){return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.RPC_REQUEST,action:OT.Raptor.Actions.FORCE_UNPUBLISH,payload:{sessionId:d,connectionId:a,streamId:b,webRTCStream:!0},replyTo:a})};OT.Raptor.Message.jsepOffer=function(a,d,b,c){return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.JSEP,action:OT.Raptor.Actions.OFFER,payload:{fromAddress:a,toAddresses:d,sdp:c,streamId:b},replyTo:a})};OT.Raptor.Message.jsepAnswer=
function(a,d,b,c){return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.JSEP,action:OT.Raptor.Actions.ANSWER,payload:{fromAddress:a,toAddresses:d,sdp:c,streamId:b},replyTo:a})};OT.Raptor.Message.jsepSubscribe=function(a,d,b,c,e){return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.JSEP,action:OT.Raptor.Actions.SUBSCRIBE,payload:{keyManagemenMethod:OT.$.supportedCryptoScheme(),bundleSupport:OT.$.supportsBundle(),rtcpMuxSupport:OT.$.supportsRtcpMux(),fromAddress:a,toAddresses:d,streamId:b,
hasVideo:c,hasAudio:e},replyTo:a})};OT.Raptor.Message.jsepUnsubscribe=function(a,d,b){return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.JSEP,action:OT.Raptor.Actions.UNSUBSCRIBE,payload:{fromAddress:a,toAddresses:d,streamId:b},replyTo:a})};OT.Raptor.Message.jsepCandidate=function(a,d,b,c){return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.JSEP,action:OT.Raptor.Actions.CANDIDATE,payload:{fromAddress:a,toAddresses:d,candidate:c,streamId:b},replyTo:a})};OT.Raptor.Message.subscriberModify=
function(a,d,b,c,e,g){return OT.Raptor.serializeMessage({id:OT.$.uuid(),type:OT.Raptor.Types.SUBSCRIBER,action:OT.Raptor.Actions.UPDATE,payload:{key:[d,"SUBSCRIBER",b,a,e].join("/"),value:g},replyTo:a})};OT.Raptor.Message.signal=function(a,d,b,c,e){var g={id:OT.$.uuid(),fromAddress:a};c&&!Array.isArray(c)?g.toAddresses=[c]:g.toAddresses=!c||0===c.length?[d]:c;void 0!==b&&(g.type=b);void 0!==e&&(g.data=e);return OT.Raptor.serializeMessage({id:a,type:OT.Raptor.Types.SIGNAL,action:OT.Raptor.Actions.SIGNAL,
payload:g,replyTo:a})}})(this);
(function(k){OT.Signal=function(c,e,g){var a=function(a){if(a){if(!Array.isArray(a))return{code:400,reason:"The To field was invalid"}}else return{code:400,reason:"The signal type was null or an empty String. Either set it to a non-empty String value or omit it"};for(var b=0;b<a.length;b++)if(!(a[b]instanceof OT.Connection||a[b]instanceof OT.Session))return{code:400,reason:"The To field was invalid"};return null},d=function(a){var b=null;null===a||void 0===a?b={code:400,reason:"The signal type was null or undefined. Either set it to a String value or omit it"}:
128<a.length?b={code:413,reason:"The signal type was too long, the maximum length of it is 128 characters"}:/^[a-zA-Z0-9\-\._~]+$/.exec(a)||(b={code:400,reason:"The signal type was invalid, it can only contain letters, numbers, '-', '_', and '~'."});return b},b=function(a){var b=null;if(null===a||void 0===a)b={code:400,reason:"The signal data was null or undefined. Either set it to a String value or omit it"};else try{8192<JSON.stringify(a).length&&(b={code:413,reason:"The data field was too long, the maximum size of it is 8192 characters"})}catch(d){b=
{code:400,reason:"The data field was not valid JSON"}}return b};this.toRaptorMessage=function(){var a;this.to&&(a=this.to.map(function(a){return"string"===typeof a?a:a.id}));return OT.Raptor.Message.signal(e,c,this.type,a,this.data)};this.toHash=function(){var a=OT.$.clone(g);void 0===a.to&&(a.to=null);void 0===a.data&&(a.data=null);return a};this.error=null;g&&(g.hasOwnProperty("data")&&(this.data=OT.$.clone(g.data),this.error=b(this.data)),g.hasOwnProperty("to")&&(Array.isArray(g.to)?this.to=OT.$.clone(g.to):
this.to=[g.to],this.error||(this.error=a(this.to))),g.hasOwnProperty("type")&&(this.error||(this.error=d(g.type)),this.type=g.type));this.valid=null===this.error}})(this);
(function(k){function c(c,g,a){this.code=c;this.reason=g;this.signal=a}OT.Raptor.Socket=function(e,g,a){var d=OT.properties.messagingProtocol+"://"+g+":"+OT.properties.messagingPort+"/rumorwebsocketsv2",b="symphony."+g,h,f,l,k,m=new OT.Capabilities([]),r=new OT.Analytics,q=OT.$.statable(this,["disconnected","connecting","connected","error","disconnecting"],"disconnected"),t=function(a,b,d,c){a={action:"Connect",variation:a,payload_type:b,payload:d,session_id:h,partner_id:OT.APIKEY,widget_id:e,widget_type:"Controller"};
c&&(a=OT.$.extend(c,a));r.logEvent(a)},p=function(a,b,c){a?(t("Failure","reason",c+a.code+":"+a.message),q("error")):(t("Success","webSocketServerUrl",d,{connectionId:f.id}),q("connected"),m=new OT.Capabilities(b.permissions));k.apply(null,arguments)},s=function(a){var b=OT.sessions.get(h).connection,d=this.is("disconnecting")?"clientDisconnected":"networkDisconnected";a&&4001==a.code&&(d="networkTimedout");q("disconnected");b&&(b.destroyedReason?console.debug("OT.Raptor.Socket: Socket was closed but the connection had already been destroyed. Reason: "+
b.destroyedReason):b.destroy(d))}.bind(this),u=function(){};this.permittedTo=function(a){return 1===m[a]};this.connect=function(a,c,m){this.is("disconnected","error")?(q("connecting"),h=c.sessionId,k=m,m=OT.$.uuid(),OT.sessions.get(h),t("Attempt","webSocketServerUrl|userAgent|sdkVersion|chromeFrame",[d,navigator.userAgent,OT.properties.version,window.externalHost?"yes":"no"].map(function(a){return a.replace("|","\\|")}).join("|")),f=new OT.Rumor.Socket(d,b),f.onClose=s,f.onMessage=l.dispatch.bind(l),
f.connect(m,function(b){b?p(b,null,"RumorConnection:"):(f.onError=u,OT.debug("Raptor Socket connected to "+h+" on "+g),f.subscribe([h]),b=OT.Raptor.Message.connect(e,f.id,h,OT.APIKEY,a,c.p2pEnabled),this.publish(b))}.bind(this))):OT.warn("Cannot connect the Raptor Socket as it is currently connected. You should disconnect first.")};this.disconnect=function(){this.is("disconnected")||(q("disconnecting"),f.disconnect())};this.publish=function(a){f.isNot("connected")?OT.error("OT.Raptor.Socket: cannot publish until the socket is connected."+
a):(OT.debug("OT.Raptor.Socket Publish: "+a),f.publish([b],a))};this.createStream=function(a,b,d,c,e,g,l){var m=OT.sessions.get(h);a=OT.Raptor.Message.streamCreate(f.id,h,a,b,d,c,e,g,l,m.sessionInfo.p2pEnabled);this.publish(a)};this.updateStream=function(a,b,d){this.publish(OT.Raptor.Message.streamModify(f.id,h,a,b,d))};this.destroyStream=function(a){this.publish(OT.Raptor.Message.streamDestroy(f.id,h,a))};this.modifySubscriber=function(a,b,d){this.publish(OT.Raptor.Message.subscriberModify(f.id,
h,a.streamId,a.widgetId,b,d))};this.forceDisconnect=function(a){this.publish(OT.Raptor.Message.forceDisconnect(f.id,a,h))};this.forceUnpublish=function(a){this.publish(OT.Raptor.Message.forceUnpublish(f.id,h,a))};this.jsepSubscribe=function(a,b,d,c){this.publish(OT.Raptor.Message.jsepSubscribe(f.id,a,b,d,c))};this.jsepUnsubscribe=function(a,b){this.publish(OT.Raptor.Message.jsepUnsubscribe(f.id,a,b))};this.jsepCandidate=function(a,b,d){this.publish(OT.Raptor.Message.jsepCandidate(f.id,a,b,d))};this.jsepOffer=
function(a,b,d){this.publish(OT.Raptor.Message.jsepOffer(f.id,a,b,d))};this.jsepAnswer=function(a,b,d){this.publish(OT.Raptor.Message.jsepAnswer(f.id,a,b,d))};this.signal=function(a,b){var d=new OT.Signal(h,f.id,a||{});d.valid?(this.publish(d.toRaptorMessage()),b&&OT.$.isFunction(b)&&b(null,d.toHash())):b&&OT.$.isFunction(b)&&b(new c(d.error.code,d.error.reason,d.toHash()))};OT.$.defineGetters(this,{id:function(){return f.id},capabilities:function(){return m},sessionId:function(){return h}});l=new (a||
OT.Raptor.Dispatcher)(this,function(a,b){p.call(this,a,b,"ConnectToSession:")})}})(this);
(function(k){function c(a,d){var b=new OT.Stream(a.streamId,d.connections.get(a.connection.connectionId),a.name,a.streamData,a.type,a.creationTime,a.hasAudio,a.hasVideo,a.orientation?a.orientation.videoOrientation:null,a.peerId,a.quality,a.orientation?a.orientation.width:null,a.orientation?a.orientation.height:null);a.publisherId&&(b.publisherId=a.publisherId);return b}function e(a,d){if(!d.streams.has(a.streamId)){var b=c(a,d);d.streams.add(b);return b}}var g={409:"This P2P session already has 2 participants.",
410:"The session already has four participants.",1004:"The token passed is invalid."};OT.publishers=new OT.Collection("guid");OT.subscribers=new OT.Collection("widgetId");OT.sessions=new OT.Collection;OT.Raptor.Dispatcher=function(a,d){this.socket=a;this.connectionCompletion=d};OT.Raptor.Dispatcher.prototype.dispatch=function(a,d){var b=OT.Raptor.deserializeMessage(d);if(b.typeName)if(b.actionName)switch(OT.debug("OT.Raptor.dispatch "+b.signature+": "+d),b.type){case OT.Raptor.Types.RPC_RESPONSE:this.dispatchRPCResponse(b);
break;case OT.Raptor.Types.CONNECTION:this.dispatchConnection(b);break;case OT.Raptor.Types.CONNECTIONCOUNT:this.dispatchConnectionCount(b);break;case OT.Raptor.Types.STREAM:this.dispatchStream(b);break;case OT.Raptor.Types.SUBSCRIBER:this.dispatchSubscriber(b);break;case OT.Raptor.Types.MODERATION:this.dispatchModeration(b);break;case OT.Raptor.Types.JSEP:this.dispatchJsep(b);break;case OT.Raptor.Types.SIGNAL:this.dispatchSignal(b);break;default:OT.warn("OT.Raptor.dispatch: Type "+b.typeName+" is not currently implemented")}else OT.error("OT.Raptor.dispatch: Invalid action ("+
b.action+") for "+b.typeName),OT.error(b);else OT.error("OT.Raptor.dispatch: Invalid message type ("+b.type+")")};OT.Raptor.Dispatcher.prototype.dispatchRPCResponse=function(a){switch(a.action){case OT.Raptor.Actions.CONNECT:if(!1==a.payload.connectSuccess){var d=new OT.Error(OT.ExceptionCodes.CONNECT_REJECTED,g[a.payload.reason]||"Failed to connect");this.connectionCompletion.call(null,d)}else this.socket.publish(OT.Raptor.Message.getSessionState(this.socket.id,a.payload.sessionId,!0));break;case OT.Raptor.Actions.STATE:d=
a.payload.value;a=OT.sessions.get(a.payload.key);var b;d.streams=[];d.connections=[];d.archives=[];if(d.hasOwnProperty("CONNECTIONS")){for(var c in d.CONNECTIONS)b=OT.Connection.fromHash(d.CONNECTIONS[c]),d.connections.push(b),a.connections.add(b);delete d.CONNECTIONS}if(d.hasOwnProperty("STREAMS")){for(c in d.STREAMS)d.streams.push(e(d.STREAMS[c],a));delete d.STREAMS}this.connectionCompletion.call(null,null,d);break;default:OT.warn("OT.Raptor.dispatch: "+a.signature+" is not currently implemented")}};
OT.Raptor.Dispatcher.prototype.dispatchConnection=function(a){var d=OT.sessions.get(a.payload.value.sessionId),b;if(d)switch(a.action){case OT.Raptor.Actions.CREATE:b=OT.Connection.fromHash(a.payload.value);d.connection&&b.id!==d.connection.id&&d.connections.add(b);break;case OT.Raptor.Actions.DELETE:b=d.connections.get(a.payload.value.connectionId);b.destroy(a.payload.reason);break;default:OT.warn("OT.Raptor.dispatch: "+a.signature+" is not currently implemented")}else OT.error("OT.Raptor.dispatch: Unable to determine session for "+
a.payload.value.sessionId+" on "+a.signature+" message!")};OT.Raptor.Dispatcher.prototype.dispatchConnectionCount=function(a){};OT.Raptor.Dispatcher.prototype.dispatchStream=function(a){var d=a.payload.key.split("/"),b=d[0],h,f;b&&(h=OT.sessions.get(b));if(h)switch(a.action){case OT.Raptor.Actions.REGISTER:f=c(a.payload.value,h);f.publisherId&&((d=OT.publishers.get(f.publisherId))?d._.streamRegisteredHandler(f):OT.warn("OT.Raptor.dispatch: Could find a publisher "+f.publisherId+" for "+a.signature));
break;case OT.Raptor.Actions.CREATE:e(a.payload.value,h);break;case OT.Raptor.Actions.UPDATE:d[1]&&(f=h.streams.get(d[1]));if(!f){OT.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for "+a.signature+" message!");break}f.update(d[2],a.payload.value);break;case OT.Raptor.Actions.DELETE:d[2]&&(f=h.streams.get(d[2]));if(!f){OT.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for "+a.signature+" message!");break}f.destroy(a.payload.reason);
break;default:OT.warn("OT.Raptor.dispatch: "+a.signature+" is not currently implemented")}else OT.error("OT.Raptor.dispatch: Unable to determine sessionId, or the session does not exist, for "+a.signature+" message!")};OT.Raptor.Dispatcher.prototype.dispatchModeration=function(a){};OT.Raptor.Dispatcher.prototype.dispatchJsep=function(a){var d,b=a.payload.streamId,c;switch(a.action){case OT.Raptor.Actions.OFFER:c=[];(b=OT.subscribers.find({streamId:b}))&&c.push(b);break;case OT.Raptor.Actions.ANSWER:case OT.Raptor.Actions.PRANSWER:case OT.Raptor.Actions.SUBSCRIBE:case OT.Raptor.Actions.UNSUBSCRIBE:c=
OT.publishers.where({streamId:b});break;case OT.Raptor.Actions.CANDIDATE:c=OT.publishers.where({streamId:b}).concat(OT.subscribers.where({streamId:b}));break;default:OT.warn("OT.Raptor.dispatch: "+a.signature+" is not currently implemented");return}c.length&&(d=c[0].session.connections.get(a.payload.fromAddress),!d&&a.payload.fromAddress.match(/^symphony\./)?(d=new OT.Connection(a.payload.fromAddress,Date.now(),null,{supportsWebRTC:!0}),c[0].session.connections.add(d)):d||OT.warn("Messsage comes from a connection ("+
a.payload.fromAddress+") that we do not know about."));c.forEach(function(b){b.processMessage(a.action,d,a.payload)})};OT.Raptor.Dispatcher.prototype.dispatchSubscriber=function(a){var d=a.payload.key.split("/"),b=OT.sessions.get(d[0]),c;if(b)if(c=d[2]?b.streams.get(d[2]):null)if(d=OT.subscribers.find(function(a){return a.streamId===c.id&&a.session.id===b.id}))switch(a.action){case OT.Raptor.Actions.QUALITY_CHANGED:d.updateQuality(parseInt(a.payload.value,10));break;default:OT.warn("OT.Raptor.dispatch: "+
a.signature+" is not currently implemented")}else OT.error("OT.Raptor.dispatch: Unable to determine subscriberId, or the subscriber does not exist, for "+a.signature+" message!");else OT.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for "+a.signature+" message!");else OT.error("OT.Raptor.dispatch: Unable to determine sessionId, or the session does not exist, for "+a.signature+" message!")};OT.Raptor.Dispatcher.prototype.dispatchSignal=function(a){if(a.action!==
OT.Raptor.Actions.SIGNAL)OT.warn("OT.Raptor.dispatch: "+a.signature+" is not currently implemented");else{var d=OT.sessions.get(this.socket.sessionId);d?d._.dispatchSignal(d.connections.get(a.payload.fromAddress),a.payload.type,a.payload.data):OT.error("OT.Raptor.dispatch: "+a.signature+" ERROR - sessionId must be provided and be valid")}}})(this);
(function(k){var c=new function(){var c=!1,g=!1,a=function(){g&&c&&OT.dispatchEvent(new OT.EnvLoadedEvent(OT.Event.names.ENV_LOADED))},d=function(){g=!0;OT.$.on(k,"unload",function(){OT.publishers.destroy();OT.subscribers.destroy();OT.sessions.destroy()});OT.Config.load(OT.properties.configURL);a()},b=function(){c=!0;OT.Config.off("dynamicConfigChanged",b);OT.Config.off("dynamicConfigLoadFailed",h);a()},h=function(){b()};OT.Config.on("dynamicConfigChanged",b);OT.Config.on("dynamicConfigLoadFailed",
h);"complete"==document.readyState||"interactive"==document.readyState&&document.body?d():document.addEventListener?document.addEventListener("DOMContentLoaded",d,!1):document.attachEvent&&document.attachEvent("onreadystatechange",function(){"complete"==document.readyState&&d()});this.onLoad=function(a){if(g&&c)a();else OT.on(OT.Event.names.ENV_LOADED,a)}};OT.onLoad=function(e,g){if(g)c.onLoad(e.bind(g));else c.onLoad(e)}})(window);
(function(k){function c(a,d,b,c){var f=e[b];c=c?OT.$.clone(c):{};OT.error("TB.exception :: title: "+f+" ("+b+") msg: "+d);c.partnerId||(c.partnerId=OT.APIKEY);try{g||(g=new OT.Analytics),g.logError(b,"tb.exception",f,{details:d},c),OT.dispatchEvent(new OT.ExceptionEvent(OT.Event.names.EXCEPTION,d,f,b,a,a))}catch(l){OT.error("TB.exception :: Failed to dispatch exception - "+l.toString())}}OT.Error=function(a,d){this.code=a;this.message=d};var e={1E3:"Failed To Load",1004:"Authentication error",1005:"Invalid Session ID",
1006:"Connect Failed",1007:"Connect Rejected",1008:"Connect Time-out",1009:"Security Error",1010:"Not Connected",1011:"Invalid Parameter",1012:"Peer-to-peer Stream Play Failed",1013:"Connection Failed",1014:"API Response Failure",1500:"Unable to Publish",1510:"Unable to Signal",1520:"Unable to Force Disconnect",1530:"Unable to Force Unpublish",1540:"Unable to record archive",1550:"Unable to play back archive",1560:"Unable to create archive",1570:"Unable to load archive",2E3:"Internal Error",2001:"Embed Failed",
3E3:"Archive load exception",3001:"Archive create exception",3002:"Playback stop exception",3003:"Playback start exception",3004:"Record start exception",3005:"Record stop exception",3006:"Archive load exception",3007:"Session recording in progress",3008:"Archive recording internal failure",4E3:"WebSocket Connection Failed",4001:"WebSocket Network Disconnected"},g;OT.handleJsException=function(a,d,b){b=b||{};var e,f=b.session;f?(e={sessionId:f.sessionId},f.connected&&(e.connectionId=f.connection.connectionId),
b.target||(b.target=f)):b.sessionId&&(e={sessionId:b.sessionId},b.target||(b.target=null));c(b.target,a,d,e)};OT.exceptionHandler=function(a,d,b,e,f){var g;a&&((g=OT.components[a])||OT.warn("Could not find the component with component ID "+a));c(g,d,e,f)}})(window);(function(k){OT.ConnectionCapabilities=function(c){c.supportsWebRTC=OT.$.castToBoolean(c.supportsWebRTC);this.supportsWebRTC=c.supportsWebRTC}})(window);
(function(k){OT.Connection=function(c,e,g,a){var d;this.id=this.connectionId=c;this.creationTime=e?Number(e):null;this.data=g;this.capabilities=new OT.ConnectionCapabilities(a);this.quality=null;OT.$.eventing(this);this.destroy=function(a,c){d=a||"clientDisconnected";!0!==c&&this.dispatchEvent(new OT.DestroyedEvent("destroyed",this,d))}.bind(this);Object.defineProperties(this,{destroyed:{get:function(){return void 0!==d},enumerable:!0},destroyedReason:{get:function(){return d},enumerable:!0}})};OT.Connection.fromHash=
function(c){return new OT.Connection(c.connectionId,c.creationTime,c.data,{supportsWebRTC:c.supportsWebRTC})}})(window);
(function(k){var c="hasAudio hasVideo quality name videoDimensions orientation".split(" ");OT.Stream=function(e,g,a,d,b,h,f,l,k,m,r,q,t){var p;this.id=this.streamId=e;this.connection=g;this.name=a;this.data=d;this.type=b||"basic";this.creationTime=h?Number(h):null;this.hasAudio=OT.$.castToBoolean(f,!0);this.hasVideo=OT.$.castToBoolean(l,!0);this.peerId=m;this.quality=r;this.videoDimensions={width:q||640,height:t||480,orientation:k||OT.VideoOrientation.ROTATED_NORMAL};OT.$.eventing(this);this.update=
function(a,b){if(-1===c.indexOf(a))OT.warn('Unknown stream property "'+a+'" was modified to "'+b+'".');else{var d=this[a],e=b;switch(a){case "hasAudio":case "hasVideo":e=OT.$.castToBoolean(e,!0);this[a]=e;break;case "quality":case "name":this[a]=e;break;case "orientation":this.videoDimensions={width:e.width,height:e.height,orientation:e.videoOrientation}}d=new OT.StreamUpdatedEvent(this,a,d,e);this.dispatchEvent(d)}};this.destroy=function(a,b){p=a||"clientDisconnected";!0!==b&&this.dispatchEvent(new OT.DestroyedEvent("destroyed",
this,p))};Object.defineProperties(this,{destroyed:{get:function(){return void 0!==p},enumerable:!0},destroyedReason:{get:function(){return p},enumerable:!0}})}})(window);
(function(k){var c=k.mozRTCSessionDescription||k.RTCSessionDescription,e=k.mozRTCIceCandidate||k.RTCIceCandidate,g=function(a){return function(b){OT.debug("IceCandidateForwarder: Ice Candidate");b.candidate?a(OT.Raptor.Actions.CANDIDATE,b.candidate):OT.debug("IceCandidateForwarder: No more ICE candidates.")}},a=function(){var a=[],b=null;Object.defineProperty(this,"peerConnection",{set:function(a){b=a}});this.process=function(d){d=new e(d.candidate);b?b.addIceCandidate(d):a.push(d)};this.processPending=
function(){for(;a.length;)b.addIceCandidate(a.shift())}},d=function(a){var b=/a=rtpmap:(\d+) CN\/\d+/i,d=[],c,e;a=a.split("\r\n").filter(function(a,f){-1!==a.indexOf("m\x3daudio")&&(c=f);e=a.match(b);return null!==e?(d.push(e[1]),!1):!0});d.length&&c&&(a[c]=a[c].replace(RegExp(d.join("|"),"ig"),"").replace(/\s+/g," "));return a.join("\r\n")},b=function(a,b,c,e){var g=function(a){return function(b){e&&e(a,b)}},h=function(b){b.sdp=d(b.sdp);a.setLocalDescription(b,function(){c(b)},g("SetLocalDescription:Error while setting LocalDescription"))};
-1===b.sdp.indexOf("a\x3dcrypto")&&(b.sdp=b.sdp.replace(/^c=IN(.*)$/gmi,"c\x3dIN$1\r\na\x3dcrypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\\r\\n"));-1===b.sdp.indexOf("a\x3drtcp-fb")&&(b.sdp=b.sdp.replace(/^m=video(.*)$/gmi,"m\x3dvideo$1\r\na\x3drtcp-fb:* ccm fir\r\na\x3drtcp-fb:* nack "));a.setRemoteDescription(b,function(b){a.createAnswer(h,g("CreateAnswer:Error while setting createAnswer"),null,!1)},g("SetRemoteDescription:Error while setting RemoteDescription"))},
h=function(a,b,c){var e={mandatory:{},optional:[]},g=function(a){return function(b){c&&c(a,b)}};navigator.mozGetUserMedia&&(e.mandatory.MozDontOfferDataChannel=!0);a.createOffer(function(c){c.sdp=d(c.sdp);a.setLocalDescription(c,function(){b(c)},g("SetLocalDescription:Error while setting LocalDescription"))},g("CreateOffer:Error while creating Offer"),e)};OT.PeerConnection=function(d){var e,n=new a,m,r,q="new",t=[],p,s=OT.$.now();OT.$.eventing(this);d.iceServers||(d.iceServers=[]);var u=function(a,
b){if(t.length)t[0](a,b)}.bind(this),w=function(){if(!e){try{OT.debug('Creating peer connection config "'+JSON.stringify(d)+'".'),e=OT.$.createPeerConnection(d,{optional:[{DtlsSrtpKeyAgreement:!0}]})}catch(a){return v("NewPeerConnection: "+a.message),null}n.peerConnection=e;e.onicecandidate=g(u);e.onaddstream=B.bind(this);e.onremovestream=D.bind(this);void 0!==e.onsignalingstatechange?e.onsignalingstatechange=y.bind(this):void 0!==e.onstatechange&&(e.onstatechange=y.bind(this))}return e}.bind(this),
x=function(){n&&(n.peerConnection=null);null!==e&&(e=null,this.trigger("close"))},y=function(a){a="string"===typeof a?a:a.target&&a.target.signalingState?a.target.signalingState:a.target.readyState;OT.debug("PeerConnection.stateChange: "+a);if(a&&a.toLowerCase()!==q)switch(q=a.toLowerCase(),OT.debug("PeerConnection.stateChange: "+q),q){case "closed":x.call(this);break;case "failed":v("ICEWorkflow: Ice state failed")}},B=function(a){this.trigger("streamAdded",a.stream)},D=function(a){this.trigger("streamRemoved",
a.stream)},G=function(a){a=new c(a.sdp);w();_remoteDescriptionType=a.type;_remoteDescription=a;b(e,a,function(a){u(OT.Raptor.Actions.ANSWER,a)},function(a,b){v(a+":"+b+":PeerConnection.offerProcessor")})},E=function(a){a.sdp?(r=new c(a.sdp),_remoteDescriptionType=r.type,_remoteDescription=r,e.setRemoteDescription(r,function(){OT.debug("setRemoteDescription succeeded")},function(a){v("SetRemoteDescription:Error while setting RemoteDescription: "+a)}),n.processPending()):OT.error("PeerConnection.processMessage: Weird message, no SDP.")},
C=function(a){OT.debug("PeerConnection.processSubscribe: Sending offer to subscriber.");w();h(e,function(a){m=a;u(OT.Raptor.Actions.OFFER,m)},function(a,b){v(a+":"+b+": PeerConnection.suscribeProcessor")})},v=function(a){OT.error(a);this.trigger("error",a)}.bind(this);this.addLocalStream=function(a){w();e.addStream(a)};this.disconnect=function(){n=null;if(e){var a=e.signalingState||e.readyState;a&&"closed"!==a.toLowerCase()&&e.close();x.call(this)}this.off()};this.processMessage=function(a,b){OT.debug("PeerConnection.processMessage: Received "+
a+" from "+b.fromAddress);OT.debug(b);switch(a){case OT.Raptor.Actions.SUBSCRIBE:C.call(this,b);break;case OT.Raptor.Actions.OFFER:G.call(this,b);break;case OT.Raptor.Actions.ANSWER:E.call(this,b);break;case OT.Raptor.Actions.CANDIDATE:n.process(b);break;default:OT.debug("PeerConnection.processMessage: Received an unexpected message of type "+a+" from "+b.fromAddress+": "+JSON.stringify(b))}return this};this.registerMessageDelegate=function(a){return t.push(a)};this.unregisterMessageDelegate=function(a){a=
t.indexOf(a);-1!==a&&t.splice(a,1);return t.length};this.getStats=function(a,b){if(!0==p)OT.warn("PeerConnection.getStats: Already getting the stats!");else{p=!0;var d=OT.$.now(),c=(d-a.timeStamp)/1E3;a.timeStamp=d;var f=function(b){var d=a.videoBytesTransferred||0;return b.stat("googFrameHeightSent")?(a.videoBytesTransferred=b.stat("bytesSent"),Math.round(8*(a.videoBytesTransferred-d)/c)):b.stat("googFrameHeightReceived")?(a.videoBytesTransferred=b.stat("bytesReceived"),Math.round(8*(a.videoBytesTransferred-
d)/c)):NaN},g=function(b){var d=a.audioBytesTransferred||0;return b.stat("audioInputLevel")?(a.audioBytesTransferred=b.stat("bytesSent"),Math.round(8*(a.audioBytesTransferred-d)/c)):b.stat("audioOutputLevel")?(a.audioBytesTransferred=b.stat("bytesReceived"),Math.round(8*(a.audioBytesTransferred-d)/c)):NaN},h={},m=function(a){if(a.result){a=a.result();for(var d=0;d<a.length;d++){var c=a[d];if(c.stat){"true"===c.stat("googActiveConnection")&&(h.localCandidateType=c.stat("googLocalCandidateType"),h.remoteCandidateType=
c.stat("googRemoteCandidateType"),h.transportType=c.stat("googTransportType"));var e=f(c);isNaN(e)||(h.avgVideoBitrate=e);c=g(c);isNaN(c)||(h.avgAudioBitrate=c)}}}p=!1;b(h)};h.duration=Math.round(d-s);var d=function(a){for(var d in a)if(a.hasOwnProperty(d)&&("outboundrtp"===a[d].type||"inboundrtp"===a[d].type)){var c=a[d];-1!==c.id.indexOf("video")?(c=f(c),isNaN(c)||(h.avgVideoBitrate=c)):-1!==c.id.indexOf("audio")&&(c=g(c),isNaN(c)||(h.avgAudioBitrate=c))}p=!1;b(h)},v=function(){var a=k.navigator.userAgent.toLowerCase().match(/Firefox\/([0-9\.]+)/i),
b=null!==a&&27<=parseFloat(a[1],10);v=function(){return b};return b};e&&e.getStats?v()?e.getStats(null,d,function(a){OT.warn("Error collecting stats",a);p=!1}):e.getStats(m):(p=!1,b(h))}};Object.defineProperty(this,"remoteStreams",{get:function(){var a;if(e){if(e.getRemoteStreams)a=e.getRemoteStreams();else if(e.remoteStreams)a=e.remoteStreams;else throw Error("Invalid Peer Connection object implements no method for retrieving remote streams");a=Array.prototype.slice.call(a)}else a=[];return a}})}})(window);
(function(k){var c={};OT.PeerConnections={add:function(e,g,a){e=e.id+"_"+g.id;(g=c[e])||(g=c[e]={count:0,pc:new OT.PeerConnection(a)});g.count+=1;return g.pc},remove:function(e,g){var a=e.id+"_"+g.id,d=c[a];d&&(d.count-=1,0===d.count&&(d.pc.disconnect(),delete c[a]))}}})(window);
(function(k){OT.PublisherPeerConnection=function(c,e,g,a){var d,b=!1,h=function(){this.destroy();this.trigger("disconnected",this)},f=function(a){this.trigger("error",null,a,this);this.destroy()},l=function(a,d){if(!b&&(a===OT.Raptor.Actions.CANDIDATE||a===OT.Raptor.Actions.OFFER||a===OT.Raptor.Actions.ANSWER||a===OT.Raptor.Actions.PRANSWER))b=-1!==(a===OT.Raptor.Actions.CANDIDATE?d.candidate:d.sdp).indexOf("typ relay");switch(a){case OT.Raptor.Actions.ANSWER:case OT.Raptor.Actions.PRANSWER:e._.jsepAnswer(c.id,
g,d);break;case OT.Raptor.Actions.OFFER:this.trigger("connected");e._.jsepOffer(c.id,g,d);break;case OT.Raptor.Actions.CANDIDATE:e._.jsepCandidate(c.id,g,d)}}.bind(this);OT.$.eventing(this);this.destroy=function(){d&&OT.PeerConnections.remove(c,g);d.off();d=null};this.processMessage=function(a,b){d.processMessage(a,b)};this.getStats=function(a,b){d.getStats(a,b)};this.init=function(){var k=e.sessionInfo.iceServers.map(function(a){a=OT.$.clone(a);"turn:"===a.url.trim().substr(0,5)&&(a.username=e.id+
"."+e.connection.id+"."+g.id);return a});d=OT.PeerConnections.add(c,g,{iceServers:k});d.on({close:h,error:f},this);d.registerMessageDelegate(l);d.addLocalStream(a);Object.defineProperty(this,"remoteConnection",{value:c});Object.defineProperty(this,"hasRelayCandidates",{get:function(){return b}})}}})(window);
(function(k){OT.SubscriberPeerConnection=function(c,e,g,a){var d,b=!1,h=function(){this.destroy();this.trigger("disconnected",this)},f=function(a){this.trigger("remoteStreamAdded",a,this)},l=function(a){this.trigger("remoteStreamRemoved",a,this)},k=function(a){this.trigger("error",null,a,this)},m=function(a,d){if(!b&&(a===OT.Raptor.Actions.CANDIDATE||a===OT.Raptor.Actions.OFFER||a===OT.Raptor.Actions.ANSWER||a===OT.Raptor.Actions.PRANSWER))b=-1!==(a===OT.Raptor.Actions.CANDIDATE?d.candidate:d.sdp).indexOf("typ relay");
switch(a){case OT.Raptor.Actions.ANSWER:case OT.Raptor.Actions.PRANSWER:this.trigger("connected");e._.jsepAnswer(c.id,g,d);break;case OT.Raptor.Actions.OFFER:e._.jsepOffer(c.id,g,d);break;case OT.Raptor.Actions.CANDIDATE:e._.jsepCandidate(c.id,g,d)}}.bind(this),r=function(a){var b="get"+(a?"Video":"Audio")+"Tracks";return function(a){var c=d.remoteStreams,e;if(0!==c.length&&c[0][b])for(var f=0,g=c.length;f<g;++f){e=c[f];e=e[b]();for(var h=0,l=e.length;h<l;++h)e[h].enabled=a}}};OT.$.eventing(this);
this.destroy=function(){d&&(0===d.unregisterMessageDelegate(m)&&(e&&(e.connected&&g&&!g.destroyed)&&e._.jsepUnsubscribe(g),this.subscribeToAudio(!1)),OT.PeerConnections.remove(c,g.streamId));d=null;this.off()};this.processMessage=function(a,b){d.processMessage(a,b)};this.getStats=function(a,b){d.getStats(a,b)};this.subscribeToAudio=r(!1);this.subscribeToVideo=r(!0);Object.defineProperty(this,"hasRelayCandidates",{get:function(){return b}});this.init=function(){var b=e.sessionInfo.iceServers.map(function(a){a=
OT.$.clone(a);"turn:"===a.url.trim().substr(0,5)&&(a.username=e.id+"."+e.connection.id+"."+g.id);return a});d=OT.PeerConnections.add(c,g.streamId,{iceServers:b});d.on({close:h,streamAdded:f,streamRemoved:l,error:k},this);b=d.registerMessageDelegate(m);0<d.remoteStreams.length?d.remoteStreams.forEach(f,this):1===b&&e._.jsepSubscribe(g,a.subscribeToVideo,a.subscribeToAudio)}}})(window);
(function(k){OT.Chrome=function(c){var e={},g=function(a,d){d.parent=this;d.appendTo(c.parent);e[a]=d;Object.defineProperty(this,a,{get:function(){return e[a]}})};c.parent&&(OT.$.eventing(this),this.destroy=function(){this.off();this.hide();for(var a in e)e[a].destroy()},this.show=function(){for(var a in e)e[a].show()},this.hide=function(){for(var a in e)e[a].hide()},this.set=function(a,d){if("string"===typeof a&&d)g.call(this,a,d);else for(var b in a)a.hasOwnProperty(b)&&g.call(this,b,a[b]);return this})}})(window);
(function(k){OT.Chrome.Behaviour||(OT.Chrome.Behaviour={});OT.Chrome.Behaviour.Widget=function(c,e){var g=e||{},a,d;c.setDisplayMode=function(b){b=b||"auto";a!==b&&(OT.$.removeClass(this.domElement,"OT_mode-"+a),OT.$.addClass(this.domElement,"OT_mode-"+b),d=a,a=b)};c.show=function(){this.setDisplayMode(d);if(g.onShow)g.onShow();return this};c.hide=function(){this.setDisplayMode("off");if(g.onHide)g.onHide();return this};c.destroy=function(){if(g.onDestroy)g.onDestroy(this.domElement);this.domElement&&
OT.$.removeElement(this.domElement);return c};c.appendTo=function(a){this.domElement=OT.$.createElement(g.nodeName||"div",g.htmlAttributes,g.htmlContent);if(g.onCreate)g.onCreate(this.domElement);"auto"!=g.mode?c.setDisplayMode(g.mode):(c.setDisplayMode("on"),setTimeout(function(){c.setDisplayMode(g.mode)},2E3));a.appendChild(this.domElement);return c}}})(window);
(function(k){OT.Chrome.NamePanel=function(c){var e=c.name;if(!e||""===e.trim().length)e=null,c.mode="off";var g;Object.defineProperty(this,"domElement",{get:function(){return g},set:function(a){g=a}});OT.Chrome.Behaviour.Widget(this,{mode:c.mode,nodeName:"h1",htmlContent:e,htmlAttributes:{className:"OT_name"}});Object.defineProperty(this,"name",{set:function(a){e||this.setDisplayMode("auto");e=a;g.innerHTML=e}.bind(this)})}})(window);
(function(k){OT.Chrome.MuteButton=function(c){var e,g=c.muted||!1,a;Object.defineProperty(this,"domElement",{get:function(){return a},set:function(b){a=b}});var d=function(b){(g=!g)?(OT.$.addClass(a,"OT_active"),this.parent.trigger("muted",this)):(OT.$.removeClass(a,"OT_active"),this.parent.trigger("unmuted",this));return!1};OT.Chrome.Behaviour.Widget(this,{mode:c.mode,nodeName:"button",htmlContent:"Mute",htmlAttributes:{className:g?"OT_mute OT_active":"OT_mute"},onCreate:function(a){e=d.bind(this);
a.addEventListener("click",e,!1)}.bind(this),onDestroy:function(a){e=null;a.removeEventListener("click",e,!1)}.bind(this)})}})(window);
(function(k){OT.Chrome.MicVolume=function(c){var e,g=c.muted||!1,a;Object.defineProperty(this,"domElement",{get:function(){return a},set:function(b){a=b}});var d=function(b){(g=!g)?(OT.$.addClass(a,"active"),this.parent.trigger("muted",this)):(OT.$.removeClass(a,"active"),this.parent.trigger("unmuted",this));return!1};OT.Chrome.Behaviour.Widget(this,{mode:c.mode,nodeName:"button",htmlContent:"Mute",htmlAttributes:{className:"OT_mic-volume"},onCreate:function(a){e=d.bind(this);a.addEventListener("click",
e,!1)}.bind(this),onDestroy:function(a){e=null;a.removeEventListener("click",e,!1)}.bind(this)})}})(window);
(function(k){OT.Chrome.SettingsPanelButton=function(c){var e,g=function(a){this.parent.trigger("SettingsPanel:open",this);return!1},a;Object.defineProperty(this,"domElement",{get:function(){return a},set:function(d){a=d}});OT.Chrome.Behaviour.Widget(this,{mode:c.mode,nodeName:"button",htmlContent:"Settings",htmlAttributes:{className:"OT_settings-panel"},onCreate:function(a){e=g.bind(this);a.addEventListener("click",e,!1)}.bind(this),onDestroy:function(a){e=null;a.removeEventListener("click",e,!1)}.bind(this)})}})(window);
(function(k){OT.Chrome.SettingsPanel=function(c){if(c.stream){var e=c.stream,g;Object.defineProperty(this,"domElement",{get:function(){return g},set:function(a){g=a}});var a=function(){var a=e.getVideoTracks().length?e.getVideoTracks()[0].label:"None",c=e.getAudioTracks().length?e.getAudioTracks()[0].label:"None";g.innerHTML="\x3cdl\x3e                                        \x3cdt\x3eCam\x3c/dt\x3e                                        \x3cdd\x3e"+a+"\x3c/dd\x3e                                        \x3cdt\x3eMic\x3c/dt\x3e                                        \x3cdd\x3e"+
c+"\x3c/dd\x3e                                    \x3c/dl\x3e";a=OT.$.createButton("Close",{className:"OT_close"},{click:d.bind(this)});g.appendChild(a)},d=function(){this.parent.trigger("SettingsPanel:close",this);return!1};OT.Chrome.Behaviour.Widget(this,{mode:c.mode,nodeName:"section",htmlContent:"Settings",htmlAttributes:{className:"OT_settings-panel"},onCreate:a.bind(this),onShow:function(){a.call(this)}.bind(this)})}}})(window);
(function(k){OT.Chrome.OpenTokButton=function(c){var e;this.__defineGetter__("domElement",function(){return e});this.__defineSetter__("domElement",function(c){e=c});OT.Chrome.Behaviour.Widget(this,{mode:c?c.mode:null,nodeName:"span",htmlContent:"OpenTok",htmlAttributes:{className:"OT_opentok"}})}})(window);
(function(k){OT.StylableComponent=function(e,g){if(!e.trigger)throw Error("OT.StylableComponent is dependent on the mixin OT.$.eventing. Ensure that this is included in the object before StylableComponent.");var a=new c(g,function(a,b,c){c?e.trigger("styleValueChanged",a,b,c):e.trigger("styleValueChanged",a,b)});e.getStyle=function(d){return a.get(d)};e.setStyle=function(d,b,c){"string"!==typeof d?a.setAll(d,c):a.set(d,b);return this}};var c=function(c,g){var a="showMicButton showSpeakerButton showSettingsButton showCameraToggleButton nameDisplayMode buttonDisplayMode showSaveButton showRecordButton showRecordStopButton showReRecordButton showPauseButton showPlayButton showPlayStopButton showStopButton backgroundImageURI showControlPanel showRecordCounter showPlayCounter showControlBar showPreviewTime".split(" "),
d={buttonDisplayMode:["auto","off","on"],nameDisplayMode:["auto","off","on"],showSettingsButton:[!0,!1],showMicButton:[!0,!1],showCameraToggleButton:[!0,!1],showSaveButton:[!0,!1],backgroundImageURI:null,showControlBar:[!0,!1],showPlayCounter:[!0,!1],showRecordCounter:[!0,!1],showPreviewTime:[!0,!1]},b={},h=function(a,b){return"backgroundImageURI"===a||d.hasOwnProperty(a)&&-1!==d[a].indexOf(b)},f=function(a){switch(a){case "true":return!0;case "false":return!1;default:return a}};this.getAll=function(){var d=
OT.$.clone(b),c;for(c in d)0>a.indexOf(c)&&delete d[c];return d};this.get=function(a){return a?b[a]:this.getAll()};this.setAll=function(a,d){var c,e,k;for(k in a)e=f(a[k]),h(k,e)?(c=b[k],e!==c&&(b[k]=e,d||g(k,e,c))):OT.warn("Style.setAll::Invalid style property passed "+k+" : "+e);return this};this.set=function(a,d){OT.debug("Publisher.setStyle: "+a.toString());var c=f(d),e;if(!h(a,c))return OT.warn("Style.set::Invalid style property passed "+a+" : "+c),this;e=b[a];c!==e&&(b[a]=c,g(a,d,e));return this};
c&&this.setAll(c,!0)}})(window);(function(k){OT.Microphone=function(c,e){var g,a=50;Object.defineProperty(this,"muted",{get:function(){return g},set:function(a){if(g!==a){g=a;a=c.getAudioTracks();for(var b=0,e=a.length;b<e;++b)a[b].enabled=!g}}});Object.defineProperty(this,"gain",{get:function(){return a},set:function(d){OT.warn("OT.Microphone.gain IS NOT YET IMPLEMENTED");a=d}});void 0!==e?this.muted=!0===e:c.getAudioTracks().length?this.muted=!c.getAudioTracks()[0].enabled:this.muted=!1}})(window);
(function(k){OT.generateSimpleStateMachine=function(c,e,g){var a=e.slice(),d=OT.$.clone(g);return function(b){function e(a,d){b({message:a,newState:d,currentState:f,previousState:g})}var f=c,g=null;this.set=function(b){var c;-1!==a.indexOf(b)?d[f]&&-1!==d[f].indexOf(b)?c=!0:(e("'"+f+"' cannot transition to '"+b+"'",b),c=!1):(e("'"+b+"' is not a valid state",b),c=!1);c&&(g=f,f=b)};Object.defineProperties(this,{current:{get:function(){return f}},subscribing:{get:function(){return"Subscribing"===f}}})}}})(window);
(function(k){OT.SubscribingState=OT.generateSimpleStateMachine("NotSubscribing","NotSubscribing Init ConnectingToPeer BindingRemoteStream Subscribing Failed".split(" "),{NotSubscribing:["NotSubscribing","Init"],Init:["NotSubscribing","ConnectingToPeer","BindingRemoteStream"],ConnectingToPeer:["NotSubscribing","BindingRemoteStream","Failed"],BindingRemoteStream:["NotSubscribing","Subscribing","Failed"],Subscribing:["NotSubscribing","Failed"],Failed:[]});Object.defineProperty(OT.SubscribingState.prototype,
"attemptingToSubscribe",{get:function(){return-1!==["Init","ConnectingToPeer","BindingRemoteStream"].indexOf(this.current)}})})(window);
(function(k){OT.PublishingState=OT.generateSimpleStateMachine("NotPublishing","NotPublishing GetUserMedia BindingMedia MediaBound PublishingToSession Publishing Failed".split(" "),{NotPublishing:["NotPublishing","GetUserMedia"],GetUserMedia:["BindingMedia","Failed","NotPublishing"],BindingMedia:["MediaBound","Failed","NotPublishing"],MediaBound:["NotPublishing","PublishingToSession","Failed"],PublishingToSession:["NotPublishing","Publishing","Failed"],Publishing:["NotPublishing","MediaBound","Failed"],
Failed:[]});Object.defineProperties(OT.PublishingState.prototype,{attemptingToPublish:{get:function(){return-1!==["GetUserMedia","BindingMedia","MediaBound","PublishingToSession"].indexOf(this.current)}},publishing:{get:function(){return"Publishing"===this.current}}})})(window);
(function(k){var c={audio:!0,video:!0};OT.Publisher=function(){if(OT.checkSystemRequirements()){var e=OT.Publisher.nextId(),g,a,d,b,h,f,l={},k=!1,m,r,q,t,p,s=new OT.Analytics,u={},w={timeStamp:OT.$.now()},x;OT.$.eventing(this);OT.StylableComponent(this,{showMicButton:!0,showSettingsButton:!0,showCameraToggleButton:!0,nameDisplayMode:"auto",buttonDisplayMode:"auto",backgroundImageURI:null});var y=function(a,d,c,g){s.logEvent({action:a,variation:d,payload_type:c,payload:g,session_id:f?f.sessionId:null,
connection_id:f&&f.connected?f.connection.connectionId:null,partner_id:f?f.apiKey:OT.APIKEY,streamId:b?b.id:null,widget_id:e,widget_type:"Publisher"})},B=function(a){var d={widget_type:"Publisher",stream_type:"WebRTC",sessionId:f?f.sessionId:null,connectionId:f&&f.connected?f.connection.connectionId:null,partnerId:f?f.apiKey:OT.APIKEY,streamId:b?b.id:null,widgetId:e,version:OT.properties.version,media_server_name:f?f.sessionInfo.messagingServer:null,p2pFlag:f?f.sessionInfo.p2pEnabled:!1,duration:(new Date).getTime()-
r.getTime(),remote_connection_id:a};l[a].getStats(w,function(a){if(a)for(var b in a)d[b]=a[b];s.logQOS(d)})},D=function(){OT.debug("OT.Publisher.onLoaded");x.set("MediaBound");a.loading=!1;k=!0;p=(new OT.Chrome({parent:a.domElement})).set({name:new OT.Chrome.NamePanel({name:m.name,mode:this.getStyle("nameDisplayMode")}),muteButton:new OT.Chrome.MuteButton({muted:!1===m.publishAudio,mode:K.call(this,this.getStyle("showMicButton"))}),opentokButton:new OT.Chrome.OpenTokButton}).on({muted:this.publishAudio.bind(this,
!1),unmuted:this.publishAudio.bind(this,!0)});this.trigger("initSuccess",this);this.trigger("loaded",this)},G=function(a){y("publish","Failure","reason","Publisher PeerConnection Error: "+a);x.set("Failed");this.trigger("publishError","Publisher PeerConnection Error: "+a);OT.handleJsException("Publisher PeerConnection Error: "+a,OT.ExceptionCodes.P2P_CONNECTION_FAILED,{session:f,target:this})},E=function(b){OT.debug("OT.Publisher.onStreamAvailable");x.set("BindingMedia");h&&(h.stop(),h=null);h=b;
t=new OT.Microphone(h,!m.publishAudio);this.publishVideo(m.publishVideo);this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_ALLOWED,!1));d=new OT.VideoElement({attributes:{muted:!0}});d.on({streamBound:D,loadError:G,error:I},this).bindToStream(h);a.video=d},C=function(b){OT.error("OT.Publisher.onStreamAvailableError "+b.name+": "+b.message);x.set("Failed");this.trigger("publishError",b.message);a&&a.destroy();y("publish","Failure","reason","Publisher failed to access camera/mic: "+b.message);OT.handleJsException("Publisher failed to access camera/mic: "+
b.message,2E3,{session:f,target:this})},v=function(b){OT.error("OT.Publisher.onStreamAvailableError Permission Denied");x.set("Failed");this.trigger("publishError",b.message);y("publish","Failure","reason","Publisher Access Denied: Permission Denied");var d=new OT.Event(OT.Event.names.ACCESS_DENIED);this.dispatchEvent(d,function(){!d.isDefaultPrevented()&&a&&a.destroy()})},F=function(){y("accessDialog","Opened","","");this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_DIALOG_OPENED,!1))},H=function(){y("accessDialog",
"Closed","","");this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_DIALOG_CLOSED,!1))},I=function(a,b){OT.error("OT.Publisher.onVideoError");var d=b+(a?" ("+a+")":"");y("stream",null,"reason","Publisher while playing stream: "+d);x.set("Failed");x.attemptingToPublish?this.trigger("publishError",d):this.trigger("error",d);OT.handleJsException("Publisher error playing stream: "+d,2E3,{session:f,target:this})},M=function(a){OT.debug("OT.Subscriber has been disconnected from the Publisher's PeerConnection");
this.cleanupSubscriber(a.remoteConnection.id)},N=function(a,b,d){y("publish","Failure","reason|hasRelayCandidates",[b+": Publisher PeerConnection with connection "+(d&&d.remoteConnection&&d.remoteConnection.id)+" failed",d.hasRelayCandidates].join("|"));OT.handleJsException("Publisher PeerConnection Error: "+b,2E3,{session:f,target:this});d.remoteConnection&&(clearInterval(u[d.remoteConnection.id]),delete u[d.remoteConnection.id],delete l[d.remoteConnection.id]);d.off()},O=function(a){var d=l[a.id];
if(!d){var c=OT.$.now();y("createPeerConnection","Attempt","","");a.on("destroyed",this.cleanupSubscriber.bind(this,a.id));d=l[a.id]=new OT.PublisherPeerConnection(a,f,b,h);d.on({connected:function(){y("createPeerConnection","Success","pcc|hasRelayCandidates",[parseInt(OT.$.now()-c,10),d.hasRelayCandidates].join("|"));u[a.id]=setInterval(function(){B(a.id)},3E4)},disconnected:M,error:N},this);d.init()}return d},K=function(a){if(!1===a)return"off";a=this.getStyle("buttonDisplayMode");return!1===a?
"on":a},J=function(){p&&(p.destroy(),p=null);this.disconnect();t=null;d&&(d.destroy(),d=null);h&&(h.stop(),h=null);a&&(a.destroy(),a=null);this.session&&this._.unpublishFromSession(this.session);for(var c in u)clearInterval(u[c]),delete u[c];b=g=null;k=!1;_properties=f=null;x.set("NotPublishing")}.bind(this);this.publish=function(b,d){OT.debug("OT.Publisher: publish");(x.attemptingToPublish||x.publishing)&&J();x.set("GetUserMedia");m=OT.$.defaults(d||{},{publishAudio:!0,publishVideo:!0,mirror:!0});
m.constraints=OT.$.defaults(m.constraints||{},c);m.style&&this.setStyle(m.style,null,!0);m.name&&(m.name=m.name.toString());m.classNames="OT_root OT_publisher";OT.onLoad(function(){a=new OT.WidgetView(b,m);g=a.domId;OT.$.getUserMedia(m.constraints,E.bind(this),C.bind(this),F.bind(this),H.bind(this),v.bind(this))},this);return this};this.publishAudio=function(a){m.publishAudio=a;t&&(t.muted=!a);f&&b&&f._.modifyStream(b.streamId,"hasAudio",a);return this};this.publishVideo=function(d){var c=m.publishVideo;
m.publishVideo=d;f&&(b&&m.publishVideo!==c)&&f._.modifyStream(b.streamId,"hasVideo",d);if(h)for(var c=h.getVideoTracks(),e=0,g=c.length;e<g;++e)c[e].enabled=d;a&&(a.showPoster=!d);return this};this.recordQOS=function(){for(var a in l)B(a)};this.destroy=function(a,b){J();!0!==b&&this.dispatchEvent(new OT.DestroyedEvent(OT.Event.names.PUBLISHER_DESTROYED,this,a),this.off.bind(this));return this};this.disconnect=function(){for(var a in l)this.cleanupSubscriber(a)};this.cleanupSubscriber=function(a){var b=
l[a];clearInterval(u[a]);delete u[a];b&&(b.destroy(),delete l[a],y("disconnect","PeerConnection","subscriberConnection",a))};this.processMessage=function(a,b,d){OT.debug("OT.Publisher.processMessage: Received "+a+" from "+b.id);OT.debug(d);switch(a){case OT.Raptor.Actions.UNSUBSCRIBE:this.cleanupSubscriber(b.id);break;default:O.call(this,b).processMessage(a,d)}};this.getImgData=function(){return!k?(OT.error("OT.Publisher.getImgData: Cannot getImgData before the Publisher is publishing."),null):d.imgData};
this._={publishToSession:function(a){this.session=a;var b=function(){this.session&&(x.set("PublishingToSession"),q&&clearTimeout(q),q=setTimeout(function(){y("publish","Failure","reason","StreamCreated: Timed out waiting for streamRegistered");this.trigger("publishError","StreamCreated: Timed out waiting for streamRegistered")}.bind(this),3E4),a._.createStream(this.guid,m&&m.name?m.name:"",OT.VideoOrientation.ROTATED_NORMAL,d.videoWidth,d.videoHeight,m.publishAudio,m.publishVideo))};if(k)b.call(this);
else this.on("initSuccess",b,this);y("publish","Attempt","streamType","WebRTC");return this}.bind(this),unpublishFromSession:function(a){if(!this.session||a.id!==this.session.id)return OT.warn("The publisher "+this.guid+" is trying to unpublish from a session "+a.id+" it is not attached to"),this;a.connected&&this.stream&&a._.destroyStream(this.stream.id);this.disconnect();this.session=null;x.set("MediaBound");y("unpublish","Success","sessionId",a.id);return this}.bind(this),streamRegisteredHandler:function(a){clearTimeout(q);
q=null;y("publish","Success","streamType","WebRTC");this.stream=a;this.stream.on("destroyed",this.disconnect,this);a=e;e=OT.Publisher.nextId();a&&this.trigger("idUpdated",a,e);x.set("Publishing");r=new Date;this.trigger("publishSuccess")}.bind(this)};this.detectDevices=function(){OT.warn("Fixme: Haven't implemented detectDevices")};this.detectMicActivity=function(){OT.warn("Fixme: Haven't implemented detectMicActivity")};this.getEchoCancellationMode=function(){OT.warn("Fixme: Haven't implemented getEchoCancellationMode");
return"fullDuplex"};this.setMicrophoneGain=function(a){OT.warn("Fixme: Haven't implemented setMicrophoneGain")};this.getMicrophoneGain=function(){OT.warn("Fixme: Haven't implemented getMicrophoneGain");return 0.5};this.setCamera=function(a){OT.warn("Fixme: Haven't implemented setCamera")};this.setMicrophone=function(a){OT.warn("Fixme: Haven't implemented setMicrophone")};Object.defineProperties(this,{id:{get:function(){return g},enumerable:!0},guid:{get:function(){return e},enumerable:!0},stream:{get:function(){return b},
set:function(a){b=a},enumerable:!0},streamId:{get:function(){return!b?null:b.id},enumerable:!0},targetElement:{get:function(){return d.domElement}},domId:{get:function(){return g}},session:{get:function(){return f},set:function(a){f=a},enumerable:!0},isWebRTC:{get:function(){return!0}},loading:{get:function(){return a&&a.loading}}});Object.defineProperty(this._,"webRtcStream",{get:function(){return h}});this.on("styleValueChanged",function(a,b,d){if(p)switch(a){case "nameDisplayMode":p.name.setDisplayMode(b)}},
this);x=new OT.PublishingState(function(a){OT.error("Publisher State Change Failed: ",a.message);OT.debug(a)})}else OT.upgradeSystemRequirements()};OT.Publisher.nextId=OT.$.uuid})(window);
(function(k){OT.Subscriber=function(c,e){var g=OT.$.uuid(),a=c||g,d,b,h,f,l,k,m=e.session,r,q,t,p=OT.$.clone(e),s=new OT.Analytics,u=50,w,x,y={timeStamp:OT.$.now()};if(m){OT.$.eventing(this);OT.StylableComponent(this,{nameDisplayMode:"auto",buttonDisplayMode:"auto",backgroundImageURI:null});var B=function(a,b,d,c){s.logEvent({action:a,variation:b,payload_type:d,payload:c,stream_id:f?f.id:null,session_id:m?m.sessionId:null,connection_id:m&&m.connected?m.connection.connectionId:null,partner_id:m&&m.connected?
m.sessionInfo.partnerId:null,widget_id:g,widget_type:"Subscriber"})},D=function(){if(w.subscribing&&m&&m.connected){var a={widget_type:"Subscriber",stream_type:"WebRTC",session_id:m?m.sessionId:null,connectionId:m?m.connection.connectionId:null,media_server_name:m?m.sessionInfo.messagingServer:null,p2pFlag:m?m.sessionInfo.p2pEnabled:!1,partner_id:m?m.apiKey:null,stream_id:f.id,widget_id:g,version:OT.properties.version,duration:parseInt(OT.$.now()-r,10),remote_connection_id:f.connection.connectionId};
k.getStats(y,function(b){if(b)for(stat_index in b)a[stat_index]=b[stat_index];s.logQOS(a)})}},G=function(){!w.subscribing&&b&&(OT.debug("OT.Subscriber.onLoaded"),w.set("Subscribing"),r=OT.$.now(),B("createPeerConnection","Success","pcc|hasRelayCandidates",[parseInt(r-q,10),k&&k.hasRelayCandidates].join("|")),t=setInterval(D,3E4),x&&(x=null,this.subscribeToVideo(!1)),d.loading=!1,I.call(this),this.trigger("subscribeSuccess",this),this.trigger("loaded",this),B("subscribe","Success","streamId",f.id))},
E=function(){OT.debug("OT.Subscriber has been disconnected from the Publisher's PeerConnection");w.attemptingToSubscribe?(w.set("Failed"),this.trigger("subscribeError","ClientDisconnected")):w.subscribing&&w.set("Failed");this.disconnect()},C=function(a,b){w.attemptingToSubscribe?(B("createPeerConnection","Failure","reason|hasRelayCandidates",["Subscriber PeerConnection Error: "+b,k&&k.hasRelayCandidates].join("|")),w.set("Failed"),this.trigger("subscribeError",b)):w.subscribing&&(w.set("Failed"),
this.trigger("error",b));this.disconnect();B("subscribe","Failure","reason",b+":Subscriber PeerConnection Error");OT.handleJsException("Subscriber PeerConnection Error: "+b,OT.ExceptionCodes.P2P_CONNECTION_FAILED,{session:m,target:this});d&&d.addError(b)},v=function(a){OT.debug("OT.Subscriber.onRemoteStreamAdded");w.set("BindingRemoteStream");this.subscribeToAudio(p.subscribeToAudio);var c=x;this.subscribeToVideo(p.subscribeToVideo);x=c;c=new OT.VideoElement;c.setAudioVolume(u);c.on({streamBound:G,
loadError:C,error:C},this);c.bindToStream(a);b=d.video=c;b.orientation={width:f.videoDimensions.width,height:f.videoDimensions.height,videoOrientation:f.videoDimensions.orientation};B("createPeerConnection","StreamAdded","","");this.trigger("streamAdded",this)},F=function(a){OT.debug("OT.Subscriber.onStreamRemoved");b.stream==a&&(b.destroy(),b=null);this.trigger("streamRemoved",this)},H=function(a){switch(a.changedProperty){case "orientation":b.orientation={width:f.videoDimensions.width,height:f.videoDimensions.height,
videoOrientation:f.videoDimensions.orientation};break;case "hasVideo":d&&(d.showPoster=!(f.hasVideo&&p.subscribeToVideo))}},I=function(){h=(new OT.Chrome({parent:d.domElement})).set({name:new OT.Chrome.NamePanel({name:p.name,mode:this.getStyle("nameDisplayMode")}),opentokButton:new OT.Chrome.OpenTokButton}).on({muted:function(){},unmuted:function(){}})};this.recordQOS=function(){D()};this.subscribe=function(b){OT.debug("OT.Subscriber: subscribe to "+b.id);if(w.subscribing)return OT.error("OT.Subscriber.Subscribe: Cannot subscribe, already subscribing."),
!1;w.set("Init");if(!b)return OT.error("OT.Subscriber: No stream parameter."),!1;if(f)return OT.error("OT.Subscriber: Already subscribed"),!1;f=b;f.on({updated:H,destroyed:this.disconnect},this);l=b.connection.connectionId;p.name=f.name;p.classNames="OT_root OT_subscriber";p.style&&this.setStyle(p.style,null,!0);p.audioVolume&&this.setAudioVolume(p.audioVolume);p.subscribeToAudio=OT.$.castToBoolean(p.subscribeToAudio,!0);p.subscribeToVideo=OT.$.castToBoolean(p.subscribeToVideo,!0);d=new OT.WidgetView(c,
p);a=d.domId;!p.subscribeToVideo&&"Chrome"==OT.$.browser()&&(x=!0,p.subscribeToVideo=!0);q=OT.$.now();f.connection.id!==m.connection.id?(B("createPeerConnection","Attempt","",""),w.set("ConnectingToPeer"),k=new OT.SubscriberPeerConnection(f.connection,m,f,p),k.on({disconnected:E,error:C,remoteStreamAdded:v,remoteStreamRemoved:F},this),k.init()):(B("createPeerConnection","Attempt","",""),v.call(this,m.getPublisherForStream(f)._.webRtcStream));B("subscribe","Attempt","streamId",f.id);return this};this.destroy=
function(b,c){clearInterval(t);t=null;this.disconnect();h&&(h.destroy(),h=null);d&&(d.destroy(),d=null);f&&!f.destroyed&&B("unsubscribe",null,"streamId",f.id);p=m=f=a=null;!0!==c&&this.dispatchEvent(new OT.DestroyedEvent(OT.Event.names.SUBSCRIBER_DESTROYED,this,b),this.off.bind(this));return this};this.disconnect=function(){w.set("NotSubscribing");b&&(b.destroy(),b=null);k&&(k.destroy(),k=null,B("disconnect","PeerConnection","streamId",f.id))};this.processMessage=function(a,b,d){OT.debug("OT.Subscriber.processMessage: Received "+
a+" message from "+b.id);OT.debug(d);l!=b.id&&(l=b.id);k&&k.processMessage(a,d)};this.updateQuality=function(a){OT.warn("Due to high packet loss and low bandwidth, video has been disabled");this.subscribeToVideo(!1);this.dispatchEvent(new OT.Event("videoDisabled"))};this.getImgData=function(){return!this.subscribing?(OT.error("OT.Subscriber.getImgData: Cannot getImgData before the Subscriber is subscribing."),null):b.imgData};this.setAudioVolume=function(a){a=parseInt(a,10);if(isNaN(a))return OT.error("OT.Subscriber.setAudioVolume: value should be an integer between 0 and 100"),
this;u=Math.max(0,Math.min(100,a));u!=a&&OT.warn("OT.Subscriber.setAudioVolume: value should be an integer between 0 and 100");b&&b.setAudioVolume(u);return this};this.getAudioVolume=function(){return b?b.getAudioVolume():u};this.subscribeToAudio=function(a){a=OT.$.castToBoolean(a,!0);k&&(k.subscribeToAudio(a),m&&(f&&a!==p.subscribeToAudio)&&m._.modifySubscriber(this,"hasAudio",a));p.subscribeToAudio=a;return this};this.subscribeToVideo=function(a){if(x&&!0==a)x=!1;else return a=OT.$.castToBoolean(a,
!0),d&&(d.showPoster=!(a&&f.hasVideo),a&&d.video&&(d.loading=a,d.video.whenTimeIncrements(function(){d.loading=!1},this))),k&&(k.subscribeToVideo(a),m&&(f&&a!==p.subscribeToVideo)&&m._.modifySubscriber(this,"hasVideo",a)),p.subscribeToVideo=a,this};Object.defineProperties(this,{id:{get:function(){return a},enumerable:!0},widgetId:{get:function(){return g}},stream:{get:function(){return f},enumerable:!0},streamId:{get:function(){return!f?null:f.id},enumerable:!0},targetElement:{get:function(){return b?
b.domElement:null}},subscribing:{get:function(){return w.subscribing},enumerable:!0},isWebRTC:{get:function(){return!0}},loading:{get:function(){return d&&d.loading}},session:{get:function(){return m}}});this.on("styleValueChanged",function(a,b,d){if(h)switch(a){case "nameDisplayMode":h.name.setDisplayMode(b)}},this);w=new OT.SubscribingState(function(a){OT.error("Subscriber State Change Failed: ",a.message);OT.debug(a)})}else OT.handleJsException("Subscriber must be passed a session option",2E3,
{session:m,target:this})}})(window);
(function(k){OT.SessionInfo=function(c){var g=null;this.sessionStatus=this.partnerId=this.sessionId=null;this.p2pEnabled=!1;this.iceServers=this.messagingServer=null;OT.log("SessionInfo Response:");OT.log(c);c&&(c.documentElement&&null!==c.documentElement.firstElementChild)&&(g=c.documentElement.firstElementChild);c=g.firstElementChild;do switch(c.localName){case "session_id":this.sessionId=c.textContent;break;case "partner_id":this.partnerId=c.textContent;break;case "session_status":this.sessionStatus=
c.textContent;break;case "messaging_server_url":this.messagingServer=c.textContent;break;case "ice_servers":this.iceServers=normaliseIceServers(parseIceServersXml(c.childNodes));break;case "properties":if(g=c.firstElementChild){do if("p2p"===g.localName&&null!==g.firstElementChild){this.p2pEnabled="enabled"===g.firstElementChild.textContent;break}while(g=g.nextElementSibling)}}while(c=c.nextElementSibling);if(!this.iceServers||0===this.iceServers.length)OT.warn("SessionInfo contained not ICE Servers, using the default"),
this.iceServers=[{url:"stun:stun.l.google.com:19302"}]};OT.SessionInfo.get=function(c,g,a){var d=OT.properties.apiURL+"/session/"+c.id+"?extended\x3dtrue",b=OT.$.now();c.logEvent("getSessionInfo","Attempt","api_url",OT.properties.apiURL);OT.$.getXML(d,{headers:{"X-TB-TOKEN-AUTH":c.token,"X-TB-VERSION":1},success:function(d){c.logEvent("Instrumentation",null,"gsi",OT.$.now()-b);var f=parseErrorFromXMLDocument(d);!1===f?onGetResponseCallback(c,g,d):onGetErrorCallback(c,a,f)},error:function(b){onGetErrorCallback(c,
a,parseErrorFromXMLDocument(b.target.responseXML))}})};var c={};c["404"]=OT.ExceptionCodes.INVALID_SESSION_ID;c["403"]=OT.ExceptionCodes.AUTHENTICATION_ERROR;parseErrorFromXMLDocument=function(c){if(c&&c.documentElement&&null!==c.documentElement.firstElementChild){c=c.evaluate("//error",c.documentElement,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);var g=c.snapshotLength;if(0===g)return!1;for(;0<g;)return c=c.snapshotItem(0),{code:c.getAttribute("code"),message:c.firstElementChild.getAttribute("message")}}return{code:null,
message:"Unknown error: getSessionInfo XML response was badly formed"}};onGetResponseCallback=function(c,g,a){c.logEvent("getSessionInfo","Success","api_url",OT.properties.apiURL);g(new OT.SessionInfo(a))};onGetErrorCallback=function(e,g,a){TB.handleJsException("TB.SessionInfoError :: Unable to get session info "+a.message,c[a.code],{session:e});e.logEvent("Connect","Failure","errorMessage","GetSessionInfo:"+a.code+": Unable to get session info "+a.message);g(a,e)};parseIceServersXml=function(c){for(var g=
[],a,d,b=0,h=c.length;b<h;++b)"ice_server"===c[b].localName&&(d=c[b].attributes,a={url:d.getNamedItem("url").nodeValue},d.getNamedItem("credential")&&d.getNamedItem("credential").nodeValue.length&&(a.credential=d.getNamedItem("credential").nodeValue),g.push(a));return g};normaliseIceServers=function(c){var g=navigator.userAgent.match(/(Firefox)\/([0-9]+\.[0-9]+)/),a=g?parseFloat(g[2],10):void 0,d;return c.map(function(b){if("turn:"!==b.url.trim().substr(0,5))return b;if(null!==g){if(25>a)return{url:b.url.replace("turn:",
"stun:")};27>a&&-1!==b.url.indexOf("?")&&(b.url=b.url.trim().split("?")[0])}d=b.url.trim().split(/[:@]/);return{username:d[1],credential:b.credential,url:d[0]+":"+d[2]+(4===d.length?":"+d[3]:"")}})}})(window);(function(k){OT.Capabilities=function(c){this.publish=-1!==c.indexOf("publish")?1:0;this.subscribe=-1!==c.indexOf("subscribe")?1:0;this.forceUnpublish=-1!==c.indexOf("forceunpublish")?1:0;this.forceDisconnect=-1!==c.indexOf("forcedisconnect")?1:0;this.supportsWebRTC=OT.$.supportsWebRTC()?1:0}})(window);
(function(k){var c=function(c,g,a,d){var b,h={},f=function(){clearTimeout(b);c.off("exception",k)},k=function(a){h.hasOwnProperty(a.code)&&this.failed(h[a.code])};this.failsOnExceptionCodes=function(a){h=a};this.succeeded=function(){f();completionHandler&&OT.$.callAsync(completionHandler,null)};this.failed=function(a){f();completionHandler&&OT.$.callAsync(completionHandler,new OT.Error(null,a))};c.on("exception",k,this);b=setTimeout(function(){this.failed(d&&d.timeoutMessage?d.timeoutMessage:"Timed out while waiting for the server to respond.")}.bind(this),
3E4)};OT.Session=function(e){if(OT.checkSystemRequirements()){var g=!0,a,d,b,h=OT.$.uuid(),f=new OT.Analytics,k,n={},m={};OT.$.eventing(this);var r=OT.$.statable(this,["disconnected","connecting","connected","disconnecting"],"disconnected");this.connections=new OT.Collection;this.streams=new OT.Collection;var q=function(a,b){r("disconnected");OT.error(a);this.trigger("sessionConnectFailed",a);TB.handleJsException(a,b||OT.ExceptionCodes.CONNECT_FAILED,{session:this})},t=function(a){var b=a.reason;
"networkTimedout"==b?(b="networkDisconnected",this.logEvent("Connect","TimeOutDisconnect","reason",a.reason)):this.logEvent("Connect","Disconnected","reason",a.reason);var c=new OT.SessionDisconnectEvent("sessionDisconnected",b);y.call(this);B.call(this);a=function(){c.isDefaultPrevented()||D.call(this,c.reason)}.bind(this);this.dispatchEvent(c,a)},p=function(a){a.id.match(/^symphony\./)||this.dispatchEvent(new OT.ConnectionEvent(OT.Event.names.CONNECTION_CREATED,[a]))},s=function(a,c){if(!a.id.match(/^symphony\./)&&
a.id!==b.id){if(n[a.id]){var d=n[a.id];delete n[a.id];"forceDisconnected"!==c&&OT.warn("Expected a forceDisconnect for connection "+a.id+", but a "+c+" was received instead.");d.succeeded()}this.dispatchEvent(new OT.ConnectionEvent(OT.Event.names.CONNECTION_DESTROYED,[a],c))}},u=function(a){this.dispatchEvent(new OT.StreamEvent(OT.Event.names.STREAM_CREATED,[a]))},w=function(a){var b=a.target,c=a.changedProperty,d=a.newValue;"orientation"===c&&(c="videoDimensions",d={width:d.width,height:d.height});
this.dispatchEvent(new OT.StreamPropertyChangedEvent(OT.Event.names.STREAM_PROPERTY_CHANGED,b,c,a.oldValue,d))},x=function(a,b){if(m[a.id]){var c=m[a.id];delete m[a.id];"forceUnpublished"!==b&&OT.warn("Expected a forceUnpublish for stream "+a.id+", but a "+b+" destroyed was received instead.");c.succeeded()}var d=new OT.StreamEvent("streamDestroyed",[a],b),c=function(){if(!d.isDefaultPrevented()){var b=OT.publishers.where({streamId:a.id})[0];b&&(b._.unpublishFromSession(this),b.destroy());OT.subscribers.where({streamId:a.id}).forEach(function(a){a.session.id===
this.id&&this.unsubscribe(a)},this)}}.bind(this);this.dispatchEvent(d,c)},y=function(){d=a=null;r("disconnected");this.connections.destroy();this.streams.destroy()},B=function(){OT.publishers.where({session:this}).forEach(function(a){a.disconnect()});OT.subscribers.where({session:this}).forEach(function(a){a.disconnect()})},D=function(a){OT.publishers.where({session:this}).forEach(function(b){b.destroy(a)});OT.subscribers.where({session:this}).forEach(function(b){b.destroy(a)})},G=function(){TB.debug("OT.Session: connecting to Raptor");
b=new OT.Raptor.Socket(h,this.sessionInfo.messagingServer);b.connect(d,this.sessionInfo,function(a,b){a?q.call(this,a.reason,a.code):(OT.debug("OT.Session: Received session state from Raptor",b),k=this.connection.id,r("connected"),this.connection.on("destroyed",t,this),this.connections.on({add:p,remove:s},this),this.streams.on({add:u,remove:x,update:w},this),this.dispatchEvent(new OT.SessionConnectEvent(OT.Event.names.SESSION_CONNECTED,b.connections,b.streams,b.archives)))}.bind(this))},E=function(){this.is("connecting")&&
OT.SessionInfo.get(this,C.bind(this),function(a){q.call(this,a.message+(a.code?" ("+a.code+")":""))}.bind(this))},C=function(b){this.is("connecting")&&(this.sessionInfo=b,this.sessionInfo.partnerId&&this.sessionInfo.partnerId!=a?(a=this.sessionInfo.partnerId,this.logEvent("Connect","Failure","reason","GetSessionInfo:"+OT.ExceptionCodes.AUTHENTICATION_ERROR+":Authentication Error: The apiKey passed into the session.connect method does not match the apiKey in the token or session you are trying to connect to."),
q.call(this,"Authentication Error: The apiKey passed into the session.connect method does not match the apiKey in the token or session you are trying to connect to.",OT.ExceptionCodes.AUTHENTICATION_ERROR)):G.call(this))};this.logEvent=function(b,c,d,g){b={action:b,variation:c,payload_type:d,payload:g,session_id:e,partner_id:a,widget_id:h,widget_type:"Controller"};this.connection&&this.connection.id?b.connection_id=this.connection.id:k&&(b.connection_id=k);f.logEvent(b)};this.connect=function(b,c,
e){this.is("connecting","connected")?OT.warn("OT.Session: Cannot connect, the session is already "+this.state):(y.call(this),r("connecting"),d=c,g?g=!1:h=OT.$.uuid(),a=b.toString(),0===OT.APIKEY.length&&(OT.APIKEY=a),e&&OT.$.isFunction(e)&&(this.once(OT.Event.names.SESSION_CONNECTED,e.bind(null,null)),this.once("sessionConnectFailed",e)),E.call(this))};this.disconnect=function(){b&&b.isNot("disconnected")?(r("disconnecting"),b.disconnect()):y.call(this)};this.destroy=function(a,b){this.streams.destroy();
this.connections.destroy();this.disconnect()};this.publish=function(c,d,g){if(this.isNot("connected"))return f.logError(1010,"tb.exception","We need to be connected before you can publish",null,{action:"publish",variation:"Failure",payload_type:"reason",payload:"We need to be connected before you can publish",session_id:e,partner_id:a,widgetId:h,widget_type:"Controller"}),g&&OT.$.isFunction(g)&&OT.$.callAsync(g,new OT.Error(OT.ExceptionCodes.NOT_CONNECTED,"We need to be connected before you can publish")),
null;if(!b||!b.permittedTo("publish"))return this.logEvent("publish","Failure","reason","This token does not allow publishing. The role must be at least `publisher` to enable this functionality"),TB.handleJsException("This token does not allow publishing. The role must be at least `publisher` to enable this functionality",OT.ExceptionCodes.UNABLE_TO_PUBLISH,{session:this}),null;if(!c||"string"===typeof c||c.nodeType==Node.ELEMENT_NODE)c=OT.initPublisher(this.apiKey,c,d);else if(c instanceof OT.Publisher)"session"in
c&&(c.session&&"sessionId"in c.session)&&(c.session.sessionId===this.sessionId?OT.warn("Cannot publish "+c.guid+" again to "+this.sessionId+". Please call session.unpublish(publisher) first."):OT.warn("Cannot publish "+c.guid+" publisher already attached to "+c.session.sessionId+". Please call session.unpublish(publisher) first."));else throw c="Session.publish :: First parameter passed in is neither a string nor an instance of the Publisher",OT.error(c),Error(c);if(g&&OT.$.isFunction(g))c.once("publishComplete",
g);c._.publishToSession(this);return c};this.unpublish=function(a){a?a._.unpublishFromSession(this):OT.error("OT.Session.unpublish: publisher parameter missing.")};this.subscribe=function(a,b,c,d){if(!this.connection||!this.connection.connectionId)throw a="Session.subscribe :: Connection required to subscribe",OT.error(a),Error(a);if(!a)throw a="Session.subscribe :: stream cannot be null",OT.error(a),Error(a);if(!a.hasOwnProperty("streamId"))throw a="Session.subscribe :: invalid stream object",OT.error(a),
Error(a);b=new OT.Subscriber(b,OT.$.extend(c||{},{session:this}));if(d&&OT.$.isFunction(d))b.once("subscribeComplete",d);OT.subscribers.add(b);b.subscribe(a);return b};this.unsubscribe=function(a){if(!a)throw OT.error("OT.Session.unsubscribe: subscriber cannot be null"),Error("OT.Session.unsubscribe: subscriber cannot be null");if(!a.stream)return OT.warn("OT.Session.unsubscribe:: tried to unsubscribe a subscriber that had no stream"),!1;OT.debug("OT.Session.unsubscribe: subscriber "+a.id);a.destroy();
return!0};this.getSubscribersForStream=function(a){return OT.subscribers.where({streamId:a.id})};this.getPublisherForStream=function(a){if("string"!=typeof a)if("object"==typeof a&&a&&a.hasOwnProperty("id"))a=a.id;else throw errorMsg="Session.getPublisherForStream :: Invalid stream type",OT.error(errorMsg),Error(errorMsg);return OT.publishers.where({streamId:a})[0]};this._={jsepSubscribe:function(a,c,d){return b.jsepSubscribe(a.connection.id,a.id,c,d)}.bind(this),jsepUnsubscribe:function(a){return b.jsepUnsubscribe(a.connection.id,
a.id)}.bind(this),jsepCandidate:function(a,c,d){return b.jsepCandidate(a,c.id,d)}.bind(this),jsepOffer:function(a,c,d){return b.jsepOffer(a,c.id,d)}.bind(this),jsepAnswer:function(a,c,d){return b.jsepAnswer(a,c.id,d)}.bind(this),dispatchSignal:function(a,b,c){a=new OT.SignalEvent(b,c,a);a.target=this;this.trigger(OT.Event.names.SIGNAL,a);b&&this.dispatchEvent(a)}.bind(this),modifySubscriber:function(a,c,d){return b.modifySubscriber(a,c,d)}.bind(this),createStream:function(a,c,d,e,f,g,h){b.createStream(a,
c,d,e,f,g,h)}.bind(this),modifyStream:function(a,c,d){!a||!c||void 0===d?OT.error("OT.Session.modifyStream: must provide streamId, key and value to modify a stream property."):b.updateStream(a,c,d)}.bind(this),destroyStream:function(a){b.destroyStream(a)}.bind(this)};this.signal=function(a,c){b.signal(a,c)};this.forceDisconnect=function(a,d){if(b&&b.permittedTo("forceDisconnect")){var e="string"===typeof a?a:a.id;if(d){var f=new c(this,d,{timeoutMessage:"Timed out while waiting for connection "+e+
" to be force Disconnected."});f.failsOnExceptionCodes({1520:"This token does not allow forceDisconnect. The role must be at least `moderator` to enable this functionality"});n[e]=f}b.forceDisconnect(e)}else d&&OT.$.callAsync(d,new OT.Error(null,"This token does not allow forceDisconnect. The role must be at least `moderator` to enable this functionality")),TB.handleJsException("This token does not allow forceDisconnect. The role must be at least `moderator` to enable this functionality",OT.ExceptionCodes.UNABLE_TO_FORCE_DISCONNECT,
{session:this})};this.forceUnpublish=function(a,d){if(b&&b.permittedTo("forceUnpublish")){var e="string"===typeof a?this.streams.get(a):a;if(d){var f=new c(this,d,{timeoutMessage:"Timed out while waiting for stream "+e.id+" to be force unpublished."});f.failsOnExceptionCodes({1530:"This token does not allow forceUnpublish. The role must be at least `moderator` to enable this functionality"});m[e.id]=f}b.forceUnpublish(e.id)}else d&&OT.$.callAsync(d,new OT.Error(null,"This token does not allow forceUnpublish. The role must be at least `moderator` to enable this functionality")),
TB.handleJsException("This token does not allow forceUnpublish. The role must be at least `moderator` to enable this functionality",OT.ExceptionCodes.UNABLE_TO_FORCE_UNPUBLISH,{session:this})};this.getStateManager=function(){OT.warn("Fixme: Have not implemented session.getStateManager")};OT.$.defineGetters(this,{apiKey:function(){return a},token:function(){return d},connected:function(){return this.is("connected")},connection:function(){return b&&b.id?this.connections.get(b.id):null},capabilities:function(){return b?
b.capabilities:new OT.Capabilities([])},sessionId:function(){return e},id:function(){return e}},!0)}else OT.upgradeSystemRequirements()}})(window);(function(k){k=document.createElement("link");k.type="text/css";k.media="screen";k.rel="stylesheet";k.href=OT.properties.cssURL;(document.head||document.getElementsByTagName("head")[0]).appendChild(k)})(window);(function(k){"function"===typeof define&&define.amd&&define("TB",[],function(){return TB})})(window);